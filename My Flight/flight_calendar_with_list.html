
<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>飛行行事曆</title>
<style>
  :root{
    --bg:#ffffff; --text:#111827; --muted:#6b7280; --line:#e5e7eb;
    --event:#eef2ff; --brand:#1d4ed8; --card:#f9fafb;
  }
  html,body{background:var(--bg);color:var(--text);margin:0}
  body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","PingFang TC","Noto Sans TC",Roboto,"Helvetica Neue",Arial,"Microsoft JhengHei",sans-serif}
  header{position:sticky;top:0;z-index:30;background:#fff;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;padding:10px 14px}
  header h1{margin:0;font-size:18px}
  .list-btn{font-size:20px;background:none;border:none;cursor:pointer;display:none}
  .container{max-width:1200px;margin:0 auto;display:grid;grid-template-columns:3fr 1fr;gap:0}
  .calendar-wrap{padding:10px}
  .month{border-top:1px solid var(--line)}
  .month:first-of-type{border-top:none}
  .month-header{position:sticky;top:44px;background:rgba(255,255,255,.95);backdrop-filter:saturate(180%) blur(8px);border-bottom:1px solid var(--line);padding:8px 6px;z-index:10}
  .month-header h2{margin:0;font-size:16px}
  .grid{display:grid;grid-template-columns:repeat(7,minmax(0,1fr))}
  .grid.header>div{padding:6px;text-align:center;font-size:11px;color:#6b7280;border-bottom:1px solid var(--line);border-right:1px solid var(--line);background:#fafafa}
  .grid.header>div:nth-child(7n){border-right:none}
  .cell{min-height:96px;border-right:1px solid var(--line);border-bottom:1px solid var(--line);padding:6px;display:flex;flex-direction:column;gap:6px;background:#fff}
  .cell:nth-child(7n){border-right:none}
  .cell.blank{background:#fff}
  .date{font-size:12px;color:#9ca3af}
  .date.today{background:#1d4ed8;color:#fff;border-radius:50%;width:24px;height:24px;display:flex;align-items:center;justify-content:center;font-weight:600}
  .cell.today{background:linear-gradient(135deg,#f0f7ff 0%,#e0f0ff 100%)}
  .event{background:var(--event);border:1px solid #c7d2fe;border-radius:10px;padding:6px 8px;line-height:1.25;word-wrap:break-word;overflow-wrap:break-word;min-width:0}
  .event .airline{font-weight:700;font-size:12px;color:#4338ca}
  .event .route{font-size:12px;margin-top:2px}
  .event .meta{font-size:11px;color:#374151;margin-top:2px}
  .has-event{background:linear-gradient(180deg,#ffffff 0%,#ffffff 70%,#f3f6ff 100%)}
  .cell.today.has-event{background:linear-gradient(135deg,#f0f7ff 0%,#e0f0ff 100%)}
  /* 右側列表 */
  aside.flight-list{border-left:1px solid var(--line);background:#fff;padding:12px;position:sticky;top:44px;height:calc(100vh - 44px);overflow:auto}
  .flight-list h2{font-size:16px;margin:0 0 10px}
  .flight-list .card{display:block;text-decoration:none;color:inherit;border:1px solid var(--line);border-radius:12px;background:var(--card);padding:10px 12px;margin-bottom:10px}
  .flight-list .card:hover{background:#eef2ff;border-color:#c7d2fe}
  .flight-list .date-tag{font-size:12px;color:#6b7280;margin-bottom:2px}
  .flight-list .airline{font-weight:600;color:#1d4ed8;font-size:13px}
  .flight-list .route{font-size:13px;margin-top:2px}
  .flight-list .meta{font-size:12px;color:#374151;margin-top:2px}
  /* 手機版事件簡化顯示 */
  .event-compact{display:none}
  .event-full{display:block}
  
  /* 彈窗樣式 */
  .modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:50;display:none;align-items:center;justify-content:center;padding:20px;box-sizing:border-box}
  .modal-overlay.show{display:flex}
  .modal-content{background:#fff;border-radius:16px;padding:20px;width:100%;max-width:320px;box-shadow:0 20px 25px -5px rgba(0,0,0,0.1),0 10px 10px -5px rgba(0,0,0,0.04);transform:scale(0.9);transition:transform 0.2s ease}
  .modal-overlay.show .modal-content{transform:scale(1)}
  .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid var(--line)}
  .modal-title{font-size:16px;font-weight:600;color:var(--text)}
  .modal-close{background:none;border:none;font-size:24px;color:#9ca3af;cursor:pointer;padding:0;width:24px;height:24px;display:flex;align-items:center;justify-content:center}
  .modal-close:hover{color:var(--text)}
  .modal-body .airline{font-weight:600;color:#1d4ed8;font-size:14px;margin-bottom:8px}
  .modal-body .route{font-size:14px;margin-bottom:8px;color:var(--text)}
  .modal-body .meta{font-size:13px;color:#6b7280;margin-bottom:4px}
  .modal-body .time-detail{font-size:13px;color:#374151}
  
  /* 載入動畫彈窗 */
  .loading-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,0.95);z-index:60;display:none;align-items:center;justify-content:center;backdrop-filter:blur(4px)}
  .loading-overlay.show{display:flex}
  .loading-content{text-align:center;padding:40px;min-width:320px}
  .loading-text{font-size:16px;color:#374151;font-weight:500;margin-bottom:20px}
  .loading-subtext{font-size:14px;color:#6b7280;margin-top:12px}
  
  /* 進度條樣式 */
  .progress-container{width:100%;background:#e5e7eb;border-radius:10px;height:8px;margin:20px 0;overflow:hidden}
  .progress-bar{height:100%;background:linear-gradient(90deg,#1d4ed8 0%,#3b82f6 100%);border-radius:10px;width:0%;transition:width 0.15s ease;position:relative}
  .progress-bar::after{content:'';position:absolute;top:0;left:0;right:0;bottom:0;background:linear-gradient(90deg,transparent 0%,rgba(255,255,255,0.3) 50%,transparent 100%);animation:shimmer 0.8s infinite}
  .progress-text{font-size:12px;color:#6b7280;margin-top:8px}
  
  @keyframes shimmer{
    0%{transform:translateX(-100%)}
    100%{transform:translateX(100%)}
  }
  
  /* 手機：列表改為抽屜，icon 顯示 */
  @media(max-width:768px){
    .container{grid-template-columns:1fr}
    .list-btn{display:block}
    aside.flight-list{position:fixed;top:0;right:-100%;width:80%;max-width:340px;height:100vh;border-left:1px solid var(--line);box-shadow:-4px 0 16px rgba(0,0,0,.2);transition:right .28s ease;background:#fff;z-index:40}
    aside.flight-list.open{right:0}
    .month-header{top:44px}
    
    /* 手機版事件簡化顯示 */
    .event{cursor:pointer;transition:all 0.2s ease}
    .event-compact{display:block;font-size:11px}
    .event-full{display:none}
    .event-compact .time{font-weight:600;color:#4338ca}
    .event-compact .route{margin-top:1px;color:#374151}
  }
</style>
</head>
<body>
  <header>
    <h1>My Flights</h1>
    <button id="toggleList" class="list-btn" aria-label="切換清單">☰</button>
  </header>
  <div class="container">
    <div class="calendar-wrap">
<section class="month" id="m-2025-09">
  <header class="month-header"><h2>2025 年 9 月</h2></header>
  <div class="grid header">
    <div>日</div><div>一</div><div>二</div><div>三</div><div>四</div><div>五</div><div>六</div>
  </div>
  <div class="grid body">
<div class="cell blank"></div>
    <div class="cell">
      <div class="date">1</div>
      
    </div>
    <div class="cell">
      <div class="date">2</div>
      
    </div>
    <div class="cell">
      <div class="date">3</div>
      
    </div>
    <div class="cell">
      <div class="date">4</div>
      
    </div>
    <div class="cell">
      <div class="date">5</div>
      
    </div>
    <div class="cell">
      <div class="date">6</div>
      
    </div>
    <div class="cell">
      <div class="date">7</div>
      
    </div>
    <div class="cell">
      <div class="date">8</div>
      
    </div>
    <div class="cell">
      <div class="date">9</div>
      
    </div>
    <div class="cell">
      <div class="date">10</div>
      
    </div>
    <div class="cell">
      <div class="date">11</div>
      
    </div>
    <div class="cell">
      <div class="date">12</div>
      
    </div>
    <div class="cell">
      <div class="date">13</div>
      
    </div>
    <div class="cell">
      <div class="date">14</div>
      
    </div>
    <div class="cell">
      <div class="date">15</div>
      
    </div>
    <div class="cell">
      <div class="date">16</div>
      
    </div>
    <div class="cell">
      <div class="date">17</div>
      
    </div>
    <div class="cell">
      <div class="date">18</div>
      
    </div>
    <div class="cell">
      <div class="date">19</div>
      
    </div>
    <div class="cell">
      <div class="date">20</div>
      
    </div>
    <div class="cell">
      <div class="date">21</div>
      
    </div>
    <div class="cell">
      <div class="date">22</div>
      
    </div>
    <div class="cell">
      <div class="date">23</div>
      
    </div>
    <div class="cell">
      <div class="date">24</div>
      
    </div>
    <div class="cell">
      <div class="date">25</div>
      
    </div>
    <div class="cell">
      <div class="date">26</div>
      
    </div>
    <div class="cell">
      <div class="date">27</div>
      
    </div>
    <div class="cell">
      <div class="date">28</div>
      
    </div>
    <div class="cell">
      <div class="date">29</div>
      
    </div>
    <div class="cell">
      <div class="date">30</div>
      
    </div>
<div class="cell blank"></div>
<div class="cell blank"></div>
<div class="cell blank"></div>
<div class="cell blank"></div>
  </div>
</section>
<section class="month" id="m-2025-10">
  <header class="month-header"><h2>2025 年 10 月</h2></header>
  <div class="grid header">
    <div>日</div><div>一</div><div>二</div><div>三</div><div>四</div><div>五</div><div>六</div>
  </div>
  <div class="grid body">
<div class="cell blank"></div>
<div class="cell blank"></div>
<div class="cell blank"></div>
    <div class="cell">
      <div class="date">1</div>
      
    </div>
    <div class="cell">
      <div class="date">2</div>
      
    </div>
    <div class="cell">
      <div class="date">3</div>
      
    </div>
    <div class="cell has-event">
      <div class="date">4</div>
      
        <div class="event" id="d-2025-10-04">
          <div class="event-compact">
            <div class="time">02:05</div>
            <div class="route">杜哈 → 漢堡</div>
          </div>
          <div class="event-full">
            <div class="airline">卡達航空 Qatar Airways</div>
            <div class="route">杜哈 → 漢堡</div>
            <div class="meta">02:05 → 07:25 ・ QR091</div>
          </div>
        </div>
    </div>
    <div class="cell">
      <div class="date">5</div>
      
    </div>
    <div class="cell">
      <div class="date">6</div>
      
    </div>
    <div class="cell">
      <div class="date">7</div>
      
    </div>
    <div class="cell">
      <div class="date">8</div>
      
    </div>
    <div class="cell">
      <div class="date">9</div>
      
    </div>
    <div class="cell">
      <div class="date">10</div>
      
    </div>
    <div class="cell">
      <div class="date">11</div>
      
    </div>
    <div class="cell has-event">
      <div class="date">12</div>
      
        <div class="event" id="d-2025-10-12">
          <div class="event-compact">
            <div class="time">09:40</div>
            <div class="route">柏林 → 杜哈</div>
          </div>
          <div class="event-full">
            <div class="airline">卡達航空 Qatar Airways</div>
            <div class="route">柏林 → 杜哈</div>
            <div class="meta">09:40 → 16:20 ・ QR080</div>
          </div>
        </div>
        <div class="event" id="d-2025-10-12">
          <div class="event-compact">
            <div class="time">19:25</div>
            <div class="route">杜哈 → 曼谷</div>
          </div>
          <div class="event-full">
            <div class="airline">卡達航空 Qatar Airways</div>
            <div class="route">杜哈 → 曼谷</div>
            <div class="meta">19:25 → 06:15+1 ・ QR838</div>
          </div>
        </div>
    </div>
    <div class="cell has-event">
      <div class="date">13</div>
      
        <div class="event" id="d-2025-10-13">
          <div class="event-compact">
            <div class="time">08:25</div>
            <div class="route">曼谷 → 桃園</div>
          </div>
          <div class="event-full">
            <div class="airline">泰國航空 Thai Airways</div>
            <div class="route">曼谷 → 台北桃園</div>
            <div class="meta">08:25 → 13:05 ・ TG632</div>
          </div>
        </div>
    </div>
    <div class="cell">
      <div class="date">14</div>
      
    </div>
    <div class="cell">
      <div class="date">15</div>
      
    </div>
    <div class="cell">
      <div class="date">16</div>
      
    </div>
    <div class="cell">
      <div class="date">17</div>
      
    </div>
    <div class="cell">
      <div class="date">18</div>
      
    </div>
    <div class="cell">
      <div class="date">19</div>
      
    </div>
    <div class="cell">
      <div class="date">20</div>
      
    </div>
    <div class="cell">
      <div class="date">21</div>
      
    </div>
    <div class="cell">
      <div class="date">22</div>
      
    </div>
    <div class="cell">
      <div class="date">23</div>
      
    </div>
    <div class="cell has-event">
      <div class="date">24</div>
      
        <div class="event" id="d-2025-10-24">
          <div class="event-compact">
            <div class="time">11:30</div>
            <div class="route">松山 → 虹橋</div>
          </div>
          <div class="event-full">
            <div class="airline">上海航空 Shanghai Airlines</div>
            <div class="route">台北松山 → 上海虹橋</div>
            <div class="meta">11:30 → 13:30 ・ FM852</div>
          </div>
        </div>
    </div>
    <div class="cell">
      <div class="date">25</div>
      
    </div>
    <div class="cell">
      <div class="date">26</div>
      
    </div>
    <div class="cell has-event">
      <div class="date">27</div>
      
        <div class="event" id="d-2025-10-27">
          <div class="event-compact">
            <div class="time">18:25</div>
            <div class="route">虹橋 → 威海</div>
          </div>
          <div class="event-full">
            <div class="airline">中國東方航空 China Eastern</div>
            <div class="route">上海虹橋 → 威海</div>
            <div class="meta">18:25 → 20:10 ・ MU5581</div>
          </div>
        </div>
    </div>
    <div class="cell">
      <div class="date">28</div>
      
    </div>
    <div class="cell">
      <div class="date">29</div>
      
    </div>
    <div class="cell">
      <div class="date">30</div>
      
    </div>
    <div class="cell has-event">
      <div class="date">31</div>
      
        <div class="event" id="d-2025-10-31">
          <div class="event-compact">
            <div class="time">13:15</div>
            <div class="route">青島 → 仁川</div>
          </div>
          <div class="event-full">
            <div class="airline">中國東方航空 China Eastern</div>
            <div class="route">青島 → 首爾仁川</div>
            <div class="meta">13:15 → 15:50 ・ MU559</div>
          </div>
        </div>
    </div>
<div class="cell blank"></div>
  </div>
</section>
<section class="month" id="m-2025-11">
  <header class="month-header"><h2>2025 年 11 月</h2></header>
  <div class="grid header">
    <div>日</div><div>一</div><div>二</div><div>三</div><div>四</div><div>五</div><div>六</div>
  </div>
  <div class="grid body">
<div class="cell blank"></div>
<div class="cell blank"></div>
<div class="cell blank"></div>
<div class="cell blank"></div>
<div class="cell blank"></div>
<div class="cell blank"></div>
    <div class="cell">
      <div class="date">1</div>
      
    </div>
    <div class="cell has-event">
      <div class="date">2</div>
      
        <div class="event" id="d-2025-11-02">
          <div class="event-compact">
            <div class="time">19:45</div>
            <div class="route">仁川 → 桃園</div>
          </div>
          <div class="event-full">
            <div class="airline">長榮航空 EVA Air</div>
            <div class="route">首爾仁川 → 台北桃園</div>
            <div class="meta">19:45 → 21:40 ・ BR159</div>
          </div>
        </div>
    </div>
    <div class="cell">
      <div class="date">3</div>
      
    </div>
    <div class="cell">
      <div class="date">4</div>
      
    </div>
    <div class="cell">
      <div class="date">5</div>
      
    </div>
    <div class="cell">
      <div class="date">6</div>
      
    </div>
    <div class="cell">
      <div class="date">7</div>
      
    </div>
    <div class="cell">
      <div class="date">8</div>
      
    </div>
    <div class="cell">
      <div class="date">9</div>
      
    </div>
    <div class="cell">
      <div class="date">10</div>
      
    </div>
    <div class="cell">
      <div class="date">11</div>
      
    </div>
    <div class="cell">
      <div class="date">12</div>
      
    </div>
    <div class="cell">
      <div class="date">13</div>
      
    </div>
    <div class="cell">
      <div class="date">14</div>
      
    </div>
    <div class="cell">
      <div class="date">15</div>
      
    </div>
    <div class="cell">
      <div class="date">16</div>
      
    </div>
    <div class="cell">
      <div class="date">17</div>
      
    </div>
    <div class="cell">
      <div class="date">18</div>
      
    </div>
    <div class="cell">
      <div class="date">19</div>
      
    </div>
    <div class="cell">
      <div class="date">20</div>
      
    </div>
    <div class="cell">
      <div class="date">21</div>
      
    </div>
    <div class="cell">
      <div class="date">22</div>
      
    </div>
    <div class="cell">
      <div class="date">23</div>
      
    </div>
    <div class="cell">
      <div class="date">24</div>
      
    </div>
    <div class="cell">
      <div class="date">25</div>
      
    </div>
    <div class="cell">
      <div class="date">26</div>
      
    </div>
    <div class="cell">
      <div class="date">27</div>
      
    </div>
    <div class="cell">
      <div class="date">28</div>
      
    </div>
    <div class="cell">
      <div class="date">29</div>
      
    </div>
    <div class="cell">
      <div class="date">30</div>
      
    </div>
<div class="cell blank"></div>
<div class="cell blank"></div>
<div class="cell blank"></div>
<div class="cell blank"></div>
<div class="cell blank"></div>
<div class="cell blank"></div>
  </div>
</section>
<section class="month" id="m-2026-03">
  <header class="month-header"><h2>2026 年 3 月</h2></header>
  <div class="grid header">
    <div>日</div><div>一</div><div>二</div><div>三</div><div>四</div><div>五</div><div>六</div>
  </div>
  <div class="grid body">
    <div class="cell">
      <div class="date">1</div>
      
    </div>
    <div class="cell">
      <div class="date">2</div>
      
    </div>
    <div class="cell">
      <div class="date">3</div>
      
    </div>
    <div class="cell">
      <div class="date">4</div>
      
    </div>
    <div class="cell">
      <div class="date">5</div>
      
    </div>
    <div class="cell has-event">
      <div class="date">6</div>
      
        <div class="event" id="d-2026-03-06">
          <div class="event-compact">
            <div class="time">09:20</div>
            <div class="route">松山 → 金浦</div>
          </div>
          <div class="event-full">
            <div class="airline">長榮航空 EVA Air</div>
            <div class="route">台北松山 → 首爾金浦</div>
            <div class="meta">09:20 → 12:50 ・ BR156</div>
          </div>
        </div>
    </div>
    <div class="cell">
      <div class="date">7</div>
      
    </div>
    <div class="cell has-event">
      <div class="date">8</div>
      
        <div class="event" id="d-2026-03-08">
          <div class="event-compact">
            <div class="time">13:45</div>
            <div class="route">金浦 → 松山</div>
          </div>
          <div class="event-full">
            <div class="airline">中華航空 China Airlines</div>
            <div class="route">首爾金浦 → 台北松山</div>
            <div class="meta">13:45 → 15:30 ・ CI261</div>
          </div>
        </div>
    </div>
    <div class="cell">
      <div class="date">9</div>
      
    </div>
    <div class="cell">
      <div class="date">10</div>
      
    </div>
    <div class="cell">
      <div class="date">11</div>
      
    </div>
    <div class="cell">
      <div class="date">12</div>
      
    </div>
    <div class="cell">
      <div class="date">13</div>
      
    </div>
    <div class="cell">
      <div class="date">14</div>
      
    </div>
    <div class="cell">
      <div class="date">15</div>
      
    </div>
    <div class="cell">
      <div class="date">16</div>
      
    </div>
    <div class="cell">
      <div class="date">17</div>
      
    </div>
    <div class="cell">
      <div class="date">18</div>
      
    </div>
    <div class="cell">
      <div class="date">19</div>
      
    </div>
    <div class="cell">
      <div class="date">20</div>
      
    </div>
    <div class="cell">
      <div class="date">21</div>
      
    </div>
    <div class="cell">
      <div class="date">22</div>
      
    </div>
    <div class="cell">
      <div class="date">23</div>
      
    </div>
    <div class="cell">
      <div class="date">24</div>
      
    </div>
    <div class="cell">
      <div class="date">25</div>
      
    </div>
    <div class="cell">
      <div class="date">26</div>
      
    </div>
    <div class="cell">
      <div class="date">27</div>
      
    </div>
    <div class="cell">
      <div class="date">28</div>
      
    </div>
    <div class="cell">
      <div class="date">29</div>
      
    </div>
    <div class="cell">
      <div class="date">30</div>
      
    </div>
    <div class="cell">
      <div class="date">31</div>
      
    </div>
<div class="cell blank"></div>
<div class="cell blank"></div>
<div class="cell blank"></div>
<div class="cell blank"></div>
  </div>
</section>

    </div>
    <aside id="flightList" class="flight-list">
      <h2>航班清單</h2>
      
    </aside>
  </div>
  
  <!-- 彈窗 -->
  <div id="flightModal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">航班詳情</div>
        <button class="modal-close" id="closeModal">×</button>
      </div>
      <div class="modal-body" id="modalBody">
        <!-- 動態內容 -->
      </div>
    </div>
  </div>
  
  <!-- 載入動畫 -->
  <div id="loadingModal" class="loading-overlay">
    <div class="loading-content">
      <div class="loading-text">獲取 Google Sheet 資料中</div>
      <div class="progress-container">
        <div class="progress-bar" id="progressBar"></div>
      </div>
      <div class="progress-text" id="progressText">正在連接...</div>
      <div class="loading-subtext">請稍候...</div>
    </div>
  </div>
  <script>
    // Google Apps Script Web App URL（請替換為您的實際 URL）
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbweGnvC0UWooUPwt6DBvRKagXDiJOpZwc11q3tM4FNFumXHrB34bJyXO9rZBP5_hD0s/exec';
    
    const btn = document.getElementById('toggleList');
    const list = document.getElementById('flightList');
    
    btn && btn.addEventListener('click', ()=> list.classList.toggle('open'));
    
    // 點擊選單外部區域關閉選單
    document.addEventListener('click', (e) => {
      if (window.matchMedia('(max-width: 768px)').matches && list.classList.contains('open')) {
        // 如果點擊的不是選單本身或選單按鈕
        if (!list.contains(e.target) && !btn.contains(e.target)) {
          list.classList.remove('open');
        }
      }
    });
    
    // 彈窗相關元素
    const modal = document.getElementById('flightModal');
    const modalBody = document.getElementById('modalBody');
    const closeModal = document.getElementById('closeModal');
    
    // 手機版事件點擊顯示彈窗
    document.addEventListener('click', (e) => {
      if (window.matchMedia('(max-width: 768px)').matches) {
        const event = e.target.closest('.event');
        if (event && !e.target.closest('a')) {
          e.preventDefault();
          showFlightModal(event);
        }
      }
    });
    
    // 顯示彈窗
    function showFlightModal(eventElement) {
      const fullContent = eventElement.querySelector('.event-full');
      if (fullContent) {
        modalBody.innerHTML = fullContent.innerHTML;
        modal.classList.add('show');
        document.body.style.overflow = 'hidden'; // 防止背景滾動
      }
    }
    
    // 關閉彈窗
    function hideFlightModal() {
      modal.classList.remove('show');
      document.body.style.overflow = ''; // 恢復滾動
    }
    
    // 點擊關閉按鈕
    closeModal.addEventListener('click', hideFlightModal);
    
    // 點擊遮罩關閉
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        hideFlightModal();
      }
    });
    
    function closeListOnMobile(){
      if (window.matchMedia('(max-width: 768px)').matches){
        list.classList.remove('open');
      }
    }
    
    // 進度條控制
    let progressInterval;
    
    // 顯示載入動畫
    function showLoading() {
      const loadingModal = document.getElementById('loadingModal');
      const progressBar = document.getElementById('progressBar');
      const progressText = document.getElementById('progressText');
      
      loadingModal.classList.add('show');
      
      // 清空現有內容
      const calendarWrap = document.querySelector('.calendar-wrap');
      const flightList = document.querySelector('#flightList');
      
      calendarWrap.innerHTML = '';
      // 清除航班清單（保留標題）
      const existingCards = flightList.querySelectorAll('.card');
      existingCards.forEach(card => card.remove());
      
      // 重置進度條
      progressBar.style.width = '0%';
      progressText.textContent = '正在連接...';
      
      // 快速進度條動畫
      let progress = 0;
      progressInterval = setInterval(() => {
        if (progress < 30) {
          progress += Math.random() * 8 + 2; // 更快的初始進度
          progressBar.style.width = progress + '%';
          progressText.textContent = '正在連接 Google Sheets...';
        } else if (progress < 70) {
          progress += Math.random() * 5 + 1; // 中等速度
          progressBar.style.width = progress + '%';
          progressText.textContent = '讀取航班資料...';
        } else if (progress < 85) {
          progress += Math.random() * 2 + 0.5; // 稍慢，等待實際資料
          progressBar.style.width = progress + '%';
          progressText.textContent = '處理資料格式...';
        }
      }, 50); // 更快的更新頻率
    }
    
    // 更新進度條
    function updateProgress(percent, message) {
      const progressBar = document.getElementById('progressBar');
      const progressText = document.getElementById('progressText');
      
      if (progressBar && progressText) {
        progressBar.style.width = percent + '%';
        progressText.textContent = message || '';
      }
    }
    
    // 隱藏載入動畫
    function hideLoading() {
      const loadingModal = document.getElementById('loadingModal');
      
      // 清除進度條定時器
      if (progressInterval) {
        clearInterval(progressInterval);
        progressInterval = null;
      }
      
      // 快速完成進度條動畫
      updateProgress(100, '載入完成！');
      
      // 更短的延遲，更快隱藏
      setTimeout(() => {
        loadingModal.classList.remove('show');
      }, 150);
    }
    
    // 前端時間格式化函數（備援）
    function formatTimeOnFrontend(timeStr) {
      if (!timeStr) return '';
      
      // 如果已經是 HH:MM 格式，直接返回
      if (/^\d{1,2}:\d{2}$/.test(timeStr)) {
        return timeStr;
      }
      
      // 如果是 ISO 時間格式
      if (typeof timeStr === 'string' && timeStr.includes('T')) {
        try {
          const date = new Date(timeStr);
          if (!isNaN(date.getTime())) {
            // 對於 1899 年的日期，這是 Google Sheets 的時間格式
            // 需要加上 8 小時來轉換為台灣時間 (UTC+8)
            if (date.getFullYear() === 1899) {
              const utcHours = date.getUTCHours();
              const utcMinutes = date.getUTCMinutes();
              
              // 加上 8 小時轉換為台灣時間
              let localHours = utcHours + 8;
              let localMinutes = utcMinutes;
              
              // 處理跨日情況
              if (localHours >= 24) {
                localHours -= 24;
              }
              
              console.log(`時間轉換: UTC ${utcHours}:${utcMinutes} -> 台灣時間 ${localHours}:${localMinutes}`);
              
              return `${String(localHours).padStart(2, '0')}:${String(localMinutes).padStart(2, '0')}`;
            } else {
              // 正常日期使用本地時間
              const hours = date.getHours();
              const minutes = date.getMinutes();
              return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
            }
          }
        } catch (e) {
          console.error('前端時間格式化失敗:', e);
        }
      }
      
      return timeStr;
    }
    
    // 從 Google Apps Script 載入航班資料 (使用 JSONP 避免 CORS)
    function loadFlightsFromGAS() {
      if (APPS_SCRIPT_URL === 'YOUR_APPS_SCRIPT_URL_HERE') {
        console.log('請設定 APPS_SCRIPT_URL');
        return;
      }
      
      // 顯示載入動畫並清空現有資料
      showLoading();
      console.log('正在載入航班資料...');
      
      // 建立 JSONP 回調函數
      const callbackName = 'flightDataCallback_' + Date.now();
      window[callbackName] = function(result) {
        try {
          if (result.success) {
            console.log('成功載入航班資料:', result.data);
            
            // 更新進度到85%
            updateProgress(85, '格式化時間資料...');
            
            // 在前端修正時間格式
            const flights = result.data.flights.map(flight => ({
              ...flight,
              deptTime: formatTimeOnFrontend(flight.deptTime),
              arrTime: formatTimeOnFrontend(flight.arrTime)
            }));
            
            console.log('前端格式化後的航班資料:', flights);
            
            // 更新進度到95%並立即處理
            updateProgress(95, '生成日曆...');
            
            // 減少延遲，更快完成
            setTimeout(() => {
              updateCalendarWithFlights(flights);
              updateFlightList(flights);
            }, 50);
          } else {
            console.error('載入航班資料失敗:', result.data);
            // 顯示錯誤訊息
            const calendarWrap = document.querySelector('.calendar-wrap');
            calendarWrap.innerHTML = `
              <div style="text-align:center;padding:40px;color:#ef4444;">
                <div style="font-size:18px;margin-bottom:8px;">載入失敗</div>
                <div style="font-size:14px;color:#6b7280;">${result.data.error || '無法連接到 Google Sheets'}</div>
              </div>
            `;
          }
        } catch (error) {
          console.error('處理資料錯誤:', error);
          // 顯示錯誤訊息
          const calendarWrap = document.querySelector('.calendar-wrap');
          calendarWrap.innerHTML = `
            <div style="text-align:center;padding:40px;color:#ef4444;">
              <div style="font-size:18px;margin-bottom:8px;">資料處理錯誤</div>
              <div style="font-size:14px;color:#6b7280;">請重新整理頁面或檢查網路連線</div>
            </div>
          `;
        } finally {
          // 隱藏載入動畫並清理
          hideLoading();
          delete window[callbackName];
          if (script && script.parentNode) {
            document.head.removeChild(script);
          }
        }
      };
      
      // 建立 script 標籤
      const script = document.createElement('script');
      script.src = `${APPS_SCRIPT_URL}?action=getFlights&callback=${callbackName}`;
      script.onerror = function() {
        console.error('載入 script 失敗');
        hideLoading();
        
        // 顯示網路錯誤訊息
        const calendarWrap = document.querySelector('.calendar-wrap');
        calendarWrap.innerHTML = `
          <div style="text-align:center;padding:40px;color:#ef4444;">
            <div style="font-size:18px;margin-bottom:8px;">網路連線失敗</div>
            <div style="font-size:14px;color:#6b7280;">無法連接到 Google Apps Script</div>
            <button onclick="loadFlightsFromGAS()" style="margin-top:16px;padding:8px 16px;background:#1d4ed8;color:white;border:none;border-radius:6px;cursor:pointer;">重新載入</button>
          </div>
        `;
        
        delete window[callbackName];
        if (script && script.parentNode) {
          document.head.removeChild(script);
        }
      };
      
      document.head.appendChild(script);
    }
    
    // 更新日曆顯示
    function updateCalendarWithFlights(flights) {
      // 清除現有的日曆
      const calendarWrap = document.querySelector('.calendar-wrap');
      calendarWrap.innerHTML = '';
      
      if (flights.length === 0) {
        calendarWrap.innerHTML = '<p style="text-align:center;padding:40px;color:#6b7280;">目前沒有航班資料</p>';
        return;
      }
      
      // 按月份分組航班
      const flightsByMonth = {};
      flights.forEach(flight => {
        const monthKey = flight.date.substring(0, 7); // YYYY-MM
        if (!flightsByMonth[monthKey]) {
          flightsByMonth[monthKey] = [];
        }
        flightsByMonth[monthKey].push(flight);
      });
      
      // 按時間順序排序月份
      const sortedMonths = Object.keys(flightsByMonth).sort();
      
      // 為每個有航班的月份生成日曆
      sortedMonths.forEach(monthKey => {
        const monthFlights = flightsByMonth[monthKey];
        const [year, month] = monthKey.split('-');
        const monthSection = generateMonthCalendar(parseInt(year), parseInt(month), monthFlights);
        calendarWrap.appendChild(monthSection);
      });
    }
    
    // 生成單月日曆
    function generateMonthCalendar(year, month, flights) {
      const monthNames = ['', '一月', '二月', '三月', '四月', '五月', '六月', '七月', '八月', '九月', '十月', '十一月', '十二月'];
      const daysInMonth = new Date(year, month, 0).getDate();
      const firstDay = new Date(year, month - 1, 1).getDay(); // 0=Sunday, 1=Monday, ...
      
      // 建立航班索引
      const flightsByDate = {};
      flights.forEach(flight => {
        const day = parseInt(flight.date.split('-')[2]);
        if (!flightsByDate[day]) {
          flightsByDate[day] = [];
        }
        flightsByDate[day].push(flight);
      });
      
      const section = document.createElement('section');
      section.className = 'month';
      section.id = `m-${year}-${String(month).padStart(2, '0')}`;
      
      // 月份標題
      const header = document.createElement('header');
      header.className = 'month-header';
      header.innerHTML = `<h2>${year} 年 ${monthNames[month]}</h2>`;
      section.appendChild(header);
      
      // 星期標題
      const weekHeader = document.createElement('div');
      weekHeader.className = 'grid header';
      weekHeader.innerHTML = '<div>日</div><div>一</div><div>二</div><div>三</div><div>四</div><div>五</div><div>六</div>';
      section.appendChild(weekHeader);
      
      // 日期格子
      const bodyGrid = document.createElement('div');
      bodyGrid.className = 'grid body';
      
      // 前面的空白格子
      for (let i = 0; i < firstDay; i++) {
        const blankCell = document.createElement('div');
        blankCell.className = 'cell blank';
        bodyGrid.appendChild(blankCell);
      }
      
      // 取得今天的日期
      const today = new Date();
      const todayYear = today.getFullYear();
      const todayMonth = today.getMonth() + 1;
      const todayDay = today.getDate();
      
      // 日期格子
      for (let day = 1; day <= daysInMonth; day++) {
        const cell = document.createElement('div');
        const hasFlights = flightsByDate[day] && flightsByDate[day].length > 0;
        const isToday = year === todayYear && month === todayMonth && day === todayDay;
        
        // 設定 cell 的 class
        let cellClass = 'cell';
        if (hasFlights) cellClass += ' has-event';
        if (isToday) cellClass += ' today';
        cell.className = cellClass;
        
        const dateDiv = document.createElement('div');
        dateDiv.className = isToday ? 'date today' : 'date';
        dateDiv.textContent = day;
        cell.appendChild(dateDiv);
        
        // 添加航班事件
        if (hasFlights) {
          flightsByDate[day].forEach(flight => {
            const eventEl = document.createElement('div');
            eventEl.className = 'event';
            eventEl.id = `d-${flight.date}`;
            
            eventEl.innerHTML = `
              <div class="event-compact">
                <div class="time">${flight.deptTime}</div>
                <div class="route">${flight.departureShort} → ${flight.arrivalShort}</div>
              </div>
              <div class="event-full">
                <div class="airline">${flight.airline} ${flight.airlineEn}</div>
                <div class="route">${flight.departure} → ${flight.arrival}</div>
                <div class="meta">${flight.deptTime} → ${flight.arrTime} ・ ${flight.flightNo}</div>
              </div>
            `;
            
            cell.appendChild(eventEl);
          });
        }
        
        bodyGrid.appendChild(cell);
      }
      
      // 後面的空白格子（讓最後一行填滿）
      const totalCells = firstDay + daysInMonth;
      const remainingCells = 7 - (totalCells % 7);
      if (remainingCells < 7) {
        for (let i = 0; i < remainingCells; i++) {
          const blankCell = document.createElement('div');
          blankCell.className = 'cell blank';
          bodyGrid.appendChild(blankCell);
        }
      }
      
      section.appendChild(bodyGrid);
      return section;
    }
    
    // 更新航班清單
    function updateFlightList(flights) {
      const listContainer = document.querySelector('#flightList');
      if (!listContainer) return;
      
      // 清除現有清單（保留標題）
      const existingCards = listContainer.querySelectorAll('.card');
      existingCards.forEach(card => card.remove());
      
      flights.forEach(flight => {
        const cardEl = document.createElement('a');
        cardEl.className = 'card';
        cardEl.href = `#d-${flight.date}`;
        cardEl.onclick = closeListOnMobile;
        
        cardEl.innerHTML = `
          <div class="date-tag">${flight.date}</div>
          <div class="airline">${flight.airline} ${flight.airlineEn}</div>
          <div class="route">${flight.departure} → ${flight.arrival}</div>
          <div class="meta">${flight.deptTime} → ${flight.arrTime} ・ ${flight.flightNo}</div>
        `;
        
        listContainer.appendChild(cardEl);
      });
    }
    
    // 頁面載入時自動載入資料
    document.addEventListener('DOMContentLoaded', () => {
      loadFlightsFromGAS();
    });
  </script>
</body>
</html>
