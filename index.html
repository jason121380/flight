
<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>飛行行事曆</title>
<style>
  :root{
    --bg:#ffffff; --text:#111827; --muted:#6b7280; --line:#e5e7eb;
    --event:#eef2ff; --brand:#1d4ed8; --card:#f9fafb;
  }
  html,body{background:var(--bg);color:var(--text);margin:0}
  body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","PingFang TC","Noto Sans TC",Roboto,"Helvetica Neue",Arial,"Microsoft JhengHei",sans-serif}
  header{position:sticky;top:0;z-index:30;background:#fff;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;padding:10px 14px}
  header h1{margin:0;font-size:18px}
  .list-btn{font-size:20px;background:none;border:none;cursor:pointer;display:none}
  .container{max-width:1200px;margin:0 auto;display:grid;grid-template-columns:3fr 1fr;gap:0;min-height:calc(100vh - 44px)}
  .calendar-wrap{padding:10px}
  .month{border-top:1px solid var(--line)}
  .month:first-of-type{border-top:none}
  .month-header{position:sticky;top:44px;background:rgba(255,255,255,.95);backdrop-filter:saturate(180%) blur(8px);border-bottom:1px solid var(--line);padding:8px 6px;z-index:10}
  .month-header h2{margin:0;font-size:16px}
  .grid{display:grid;grid-template-columns:repeat(7,minmax(0,1fr))}
  .grid.header>div{padding:6px;text-align:center;font-size:11px;color:#6b7280;border-bottom:1px solid var(--line);border-right:1px solid var(--line);background:#fafafa}
  .grid.header>div:nth-child(7n){border-right:none}
  .cell{min-height:96px;border-right:1px solid var(--line);border-bottom:1px solid var(--line);padding:6px;display:flex;flex-direction:column;gap:6px;background:#fff}
  .cell:nth-child(7n){border-right:none}
  .cell.blank{background:#fff}
  .date{font-size:12px;color:#9ca3af}
  .date.today{background:#1d4ed8;color:#fff;border-radius:50%;width:24px;height:24px;display:flex;align-items:center;justify-content:center;font-weight:600}
  .cell.today{background:linear-gradient(135deg,#f0f7ff 0%,#e0f0ff 100%)}
  .event{background:var(--event);border:1px solid #c7d2fe;border-radius:10px;padding:6px 8px;line-height:1.25;word-wrap:break-word;overflow-wrap:break-word;min-width:0}
  .event .airline{font-weight:700;font-size:12px;color:#4338ca}
  .event .route{font-size:12px;margin-top:2px}
  .event .meta{font-size:11px;color:#374151;margin-top:2px}
  .has-event{background:linear-gradient(180deg,#ffffff 0%,#ffffff 70%,#f3f6ff 100%)}
  .cell.today.has-event{background:linear-gradient(135deg,#f0f7ff 0%,#e0f0ff 100%)}
  /* 右側列表 */
  aside.flight-list{border-left:1px solid var(--line);background:#fff;padding:12px;position:sticky;top:44px;height:calc(100vh - 44px);overflow:auto}
  .flight-list h2{font-size:16px;margin:0 0 10px}
  .flight-list .card{display:block;text-decoration:none;color:inherit;border:1px solid var(--line);border-radius:12px;background:var(--card);padding:10px 12px;margin-bottom:10px}
  .flight-list .card:hover{background:#eef2ff;border-color:#c7d2fe}
  .flight-list .date-tag{font-size:12px;color:#6b7280;margin-bottom:2px}
  .flight-list .airline{font-weight:600;color:#1d4ed8;font-size:13px}
  .flight-list .route{font-size:13px;margin-top:2px}
  .flight-list .meta{font-size:12px;color:#374151;margin-top:2px}
  /* 手機版事件簡化顯示 */
  .event-compact{display:none}
  .event-full{display:block}
  
  /* 彈窗樣式 */
  .modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:50;display:none;align-items:center;justify-content:center;padding:20px;box-sizing:border-box}
  .modal-overlay.show{display:flex}
  .modal-content{background:#fff;border-radius:16px;padding:20px;width:100%;max-width:320px;box-shadow:0 20px 25px -5px rgba(0,0,0,0.1),0 10px 10px -5px rgba(0,0,0,0.04);transform:scale(0.9);transition:transform 0.2s ease}
  .modal-overlay.show .modal-content{transform:scale(1)}
  .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid var(--line)}
  .modal-title{font-size:16px;font-weight:600;color:var(--text)}
  .modal-close{background:none;border:none;font-size:24px;color:#9ca3af;cursor:pointer;padding:0;width:24px;height:24px;display:flex;align-items:center;justify-content:center}
  .modal-close:hover{color:var(--text)}
  .modal-body .airline{font-weight:600;color:#1d4ed8;font-size:14px;margin-bottom:8px}
  .modal-body .route{font-size:14px;margin-bottom:8px;color:var(--text)}
  .modal-body .meta{font-size:13px;color:#6b7280;margin-bottom:4px}
  .modal-body .time-detail{font-size:13px;color:#374151}
  
  /* 載入動畫彈窗 */
  .loading-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,0.95);z-index:60;display:none;align-items:center;justify-content:center;backdrop-filter:blur(4px)}
  .loading-overlay.show{display:flex}
  .loading-content{text-align:center;padding:40px;min-width:320px}
  .loading-text{font-size:16px;color:#374151;font-weight:500;margin-bottom:20px}
  .loading-subtext{font-size:14px;color:#6b7280;margin-top:12px}
  
  /* 進度條樣式 */
  .progress-container{width:100%;background:#e5e7eb;border-radius:10px;height:8px;margin:20px 0;overflow:hidden}
  .progress-bar{height:100%;background:linear-gradient(90deg,#1d4ed8 0%,#3b82f6 100%);border-radius:10px;width:0%;transition:width 0.15s ease;position:relative}
  .progress-bar::after{content:'';position:absolute;top:0;left:0;right:0;bottom:0;background:linear-gradient(90deg,transparent 0%,rgba(255,255,255,0.3) 50%,transparent 100%);animation:shimmer 0.8s infinite}
  .progress-text{font-size:12px;color:#6b7280;margin-top:8px}
  
  @keyframes shimmer{
    0%{transform:translateX(-100%)}
    100%{transform:translateX(100%)}
  }
  
  /* 手機：列表改為抽屜，icon 顯示 */
  @media(max-width:768px){
    .container{grid-template-columns:1fr}
    .list-btn{display:block}
    aside.flight-list{position:fixed;top:0;right:-100%;width:80%;max-width:340px;height:100vh;border-left:1px solid var(--line);box-shadow:-4px 0 16px rgba(0,0,0,.2);transition:right .28s ease;background:#fff;z-index:40}
    aside.flight-list.open{right:0}
    .month-header{top:44px}
    
    /* 手機版事件簡化顯示 */
    .event{cursor:pointer;transition:all 0.2s ease}
    .event-compact{display:block;font-size:11px}
    .event-full{display:none}
    .event-compact .time{font-weight:600;color:#4338ca}
    .event-compact .route{margin-top:1px;color:#374151}
  }
</style>
</head>
<body>
  <header>
    <h1>My Flights</h1>
    <button id="toggleList" class="list-btn" aria-label="切換清單">☰</button>
  </header>
  <div class="container">
    <div class="calendar-wrap">
      <!-- 日曆將由 API 動態生成 -->
    </div>
    <aside id="flightList" class="flight-list">
      <h2>航班清單</h2>
    </aside>
  </div>
  
  <!-- 彈窗 -->
  <div id="flightModal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">航班詳情</div>
        <button class="modal-close" id="closeModal">×</button>
      </div>
      <div class="modal-body" id="modalBody">
        <!-- 動態內容 -->
      </div>
    </div>
  </div>
  
  <!-- 載入動畫 -->
  <div id="loadingModal" class="loading-overlay">
    <div class="loading-content">
      <div class="loading-text">獲取 Google Sheet 資料中</div>
      <div class="progress-container">
        <div class="progress-bar" id="progressBar"></div>
      </div>
      <div class="progress-text" id="progressText">正在連接...</div>
      <div class="loading-subtext">請稍候... <span style="color:#9ca3af;font-size:12px;">(按 Escape 或點擊此處關閉)</span></div>
    </div>
  </div>
  <script>
    // 直接使用發布到網路的 CSV 連結
    const SHEETS_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQqkpj4xzdNRa2qC30VjkGq-eLJcbrv-hPRKa6si93WEFsekexY4EYXnPiZJVWldHRHrG4lR-cyKBbP/pub?gid=665636533&single=true&output=csv';
    
    const btn = document.getElementById('toggleList');
    const list = document.getElementById('flightList');
    
    btn && btn.addEventListener('click', ()=> list.classList.toggle('open'));
    
    // 點擊選單外部區域關閉選單
    document.addEventListener('click', (e) => {
      if (window.matchMedia('(max-width: 768px)').matches && list.classList.contains('open')) {
        // 如果點擊的不是選單本身或選單按鈕
        if (!list.contains(e.target) && !btn.contains(e.target)) {
          list.classList.remove('open');
        }
      }
    });
    
    // 彈窗相關元素
    const modal = document.getElementById('flightModal');
    const modalBody = document.getElementById('modalBody');
    const closeModal = document.getElementById('closeModal');
    
    // 手機版事件點擊顯示彈窗
    document.addEventListener('click', (e) => {
      if (window.matchMedia('(max-width: 768px)').matches) {
        const event = e.target.closest('.event');
        if (event && !e.target.closest('a')) {
          e.preventDefault();
          showFlightModal(event);
        }
      }
    });
    
    // 顯示彈窗
    function showFlightModal(eventElement) {
      const fullContent = eventElement.querySelector('.event-full');
      if (fullContent) {
        modalBody.innerHTML = fullContent.innerHTML;
        modal.classList.add('show');
        document.body.style.overflow = 'hidden'; // 防止背景滾動
      }
    }
    
    // 關閉彈窗
    function hideFlightModal() {
      modal.classList.remove('show');
      document.body.style.overflow = ''; // 恢復滾動
    }
    
    // 點擊關閉按鈕
    closeModal.addEventListener('click', hideFlightModal);
    
    // 點擊遮罩關閉
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        hideFlightModal();
      }
    });
    
    // 緊急關閉載入動畫的快捷鍵和點擊
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        const loadingModal = document.getElementById('loadingModal');
        if (loadingModal && loadingModal.classList.contains('show')) {
          console.log('使用 Escape 鍵關閉載入動畫');
          hideLoading();
        }
      }
    });
    
    // 點擊載入動畫關閉
    document.addEventListener('click', (e) => {
      const loadingModal = document.getElementById('loadingModal');
      if (loadingModal && loadingModal.classList.contains('show') && 
          (e.target === loadingModal || loadingModal.contains(e.target))) {
        console.log('點擊載入動畫關閉');
        hideLoading();
      }
    });
    
    function closeListOnMobile(){
      if (window.matchMedia('(max-width: 768px)').matches){
        list.classList.remove('open');
      }
    }
    
    // 進度條控制
    let progressInterval;
    
    // 顯示載入動畫
    function showLoading() {
      const loadingModal = document.getElementById('loadingModal');
      const progressBar = document.getElementById('progressBar');
      const progressText = document.getElementById('progressText');
      
      loadingModal.classList.add('show');
      
      // 清空現有內容
      const calendarWrap = document.querySelector('.calendar-wrap');
      const flightList = document.querySelector('#flightList');
      
      calendarWrap.innerHTML = '';
      // 清除航班清單（保留標題）
      const existingCards = flightList.querySelectorAll('.card');
      existingCards.forEach(card => card.remove());
      
      // 重置進度條
      progressBar.style.width = '0%';
      progressText.textContent = '正在連接...';
      
      // 快速進度條動畫
      let progress = 0;
      progressInterval = setInterval(() => {
        if (progress < 30) {
          progress += Math.random() * 8 + 2; // 更快的初始進度
          progressBar.style.width = progress + '%';
          progressText.textContent = '正在連接 Google Sheets...';
        } else if (progress < 70) {
          progress += Math.random() * 5 + 1; // 中等速度
          progressBar.style.width = progress + '%';
          progressText.textContent = '讀取航班資料...';
        } else if (progress < 85) {
          progress += Math.random() * 2 + 0.5; // 稍慢，等待實際資料
          progressBar.style.width = progress + '%';
          progressText.textContent = '處理資料格式...';
        }
      }, 50); // 更快的更新頻率
    }
    
    // 更新進度條
    function updateProgress(percent, message) {
      const progressBar = document.getElementById('progressBar');
      const progressText = document.getElementById('progressText');
      
      if (progressBar && progressText) {
        progressBar.style.width = percent + '%';
        progressText.textContent = message || '';
      }
    }
    
    // 隱藏載入動畫
    function hideLoading() {
      console.log('隱藏載入動畫');
      const loadingModal = document.getElementById('loadingModal');
      
      if (!loadingModal) {
        console.log('找不到載入動畫元素');
        return;
      }
      
      // 清除進度條定時器
      if (progressInterval) {
        clearInterval(progressInterval);
        progressInterval = null;
      }
      
      // 快速完成進度條動畫
      updateProgress(100, '載入完成！');
      
      // 立即隱藏，不等待動畫
      loadingModal.classList.remove('show');
      console.log('載入動畫已隱藏');
      
      // 確保載入動畫確實關閉
      setTimeout(() => {
        if (loadingModal.classList.contains('show')) {
          console.log('強制關閉載入動畫');
          loadingModal.style.display = 'none';
        }
      }, 100);
    }
    
    // 前端時間格式化函數（備援）
    function formatTimeOnFrontend(timeStr) {
      if (!timeStr) return '';
      
      // 如果已經是 HH:MM 格式，直接返回
      if (/^\d{1,2}:\d{2}$/.test(timeStr)) {
        return timeStr;
      }
      
      // 如果是 ISO 時間格式
      if (typeof timeStr === 'string' && timeStr.includes('T')) {
        try {
          const date = new Date(timeStr);
          if (!isNaN(date.getTime())) {
            // 對於 1899 年的日期，這是 Google Sheets 的時間格式
            // 需要加上 8 小時來轉換為台灣時間 (UTC+8)
            if (date.getFullYear() === 1899) {
              const utcHours = date.getUTCHours();
              const utcMinutes = date.getUTCMinutes();
              
              // 加上 8 小時轉換為台灣時間
              let localHours = utcHours + 8;
              let localMinutes = utcMinutes;
              
              // 處理跨日情況
              if (localHours >= 24) {
                localHours -= 24;
              }
              
              console.log(`時間轉換: UTC ${utcHours}:${utcMinutes} -> 台灣時間 ${localHours}:${localMinutes}`);
              
              return `${String(localHours).padStart(2, '0')}:${String(localMinutes).padStart(2, '0')}`;
            } else {
              // 正常日期使用本地時間
              const hours = date.getHours();
              const minutes = date.getMinutes();
              return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
            }
          }
        } catch (e) {
          console.error('前端時間格式化失敗:', e);
        }
      }
      
      return timeStr;
    }
    
    // 從 Google Sheets 載入航班資料 (使用發布到網路的 CSV)
    function loadFlightsFromGAS() {
      // 顯示載入動畫並清空現有資料
      showLoading();
      console.log('正在從發布的 Google Sheets 載入航班資料...');
      
      updateProgress(10, '連接 Google Sheets...');
      
      fetch(SHEETS_CSV_URL)
        .then(response => {
          console.log('CSV 回應狀態:', response.status);
          updateProgress(30, '下載資料...');
          
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          return response.text();
        })
        .then(csvText => {
          console.log('CSV 資料載入成功，長度:', csvText.length);
          console.log('CSV 內容預覽:', csvText.substring(0, 300));
          updateProgress(60, '解析 CSV 資料...');
          
          // 解析 CSV 資料
          const flights = parseCSVToFlights(csvText);
          console.log(`解析完成，找到 ${flights.length} 筆航班資料:`, flights);
          
          if (flights.length === 0) {
            throw new Error('解析後沒有找到任何航班資料');
          }
          
          updateProgress(85, '格式化時間資料...');
          
          // 格式化時間
          const formattedFlights = flights.map(flight => ({
            ...flight,
            deptTime: formatTimeOnFrontend(flight.deptTime),
            arrTime: formatTimeOnFrontend(flight.arrTime)
          }));
          
          updateProgress(95, '生成日曆...');
          
          setTimeout(() => {
            updateCalendarWithFlights(formattedFlights);
            updateFlightList(formattedFlights);
            hideLoading();
          }, 100);
          
        })
        .catch(error => {
          console.error('Google Sheets CSV 載入失敗:', error);
          console.log('使用的 CSV URL:', SHEETS_CSV_URL);
          hideLoading();
          
          // 提供更詳細的錯誤訊息和解決方案
          if (error.message.includes('Failed to fetch')) {
            showConnectionError(`網路連線失敗，無法存取 Google Sheets CSV。\n\n可能的解決方案：\n1. 檢查網路連線\n2. 確認 Google Sheets 已發布到網路\n3. 嘗試重新整理頁面`);
          } else {
            showConnectionError(`載入錯誤: ${error.message}`);
          }
        });
    }
    
    // 解析 CSV 資料為航班物件
    function parseCSVToFlights(csvText) {
      const lines = csvText.trim().split('\n');
      const flights = [];
      
      // 跳過第一行（標題行）
      for (let i = 1; i < lines.length; i++) {
        const line = lines[i].trim();
        if (!line) continue;
        
        // 解析 CSV 行（處理逗號分隔和引號包圍的值）
        const values = parseCSVLine(line);
        
        // 跳過空白行
        if (!values[0]) continue;
        
        const flight = {
          date: formatDate(values[0]),
          airline: values[1] || '',
          departure: values[2] || '',
          arrival: values[3] || '',
          deptTime: values[4] || '',
          arrTime: values[5] || '',
          flightNo: values[6] || '',
          airlineEn: values[7] || '',
          // 產生簡化版本的地名
          departureShort: simplifyLocation(values[2]),
          arrivalShort: simplifyLocation(values[3])
        };
        
        flights.push(flight);
      }
      
      // 按日期排序
      flights.sort((a, b) => new Date(a.date) - new Date(b.date));
      
      return flights;
    }
    
    // 解析 CSV 行（處理逗號和引號）
    function parseCSVLine(line) {
      const values = [];
      let current = '';
      let inQuotes = false;
      
      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        
        if (char === '"') {
          inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
          values.push(current.trim());
          current = '';
        } else {
          current += char;
        }
      }
      
      // 加入最後一個值
      values.push(current.trim());
      
      return values;
    }
    
    // 格式化日期為 YYYY-MM-DD
    function formatDate(date) {
      if (!date) return '';
      
      // 如果已經是正確格式，直接返回
      if (/^\d{4}-\d{2}-\d{2}$/.test(date)) {
        return date;
      }
      
      const d = new Date(date);
      if (isNaN(d.getTime())) return date.toString();
      
      const year = d.getFullYear();
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      
      return `${year}-${month}-${day}`;
    }
    
    // 簡化地名函數（從 Apps Script 複製）
    function simplifyLocation(location) {
      if (!location) return '';
      
      const simplifications = {
        '台北桃園': '桃園',
        '台北松山': '松山',
        '上海浦東': '浦東',
        '上海虹橋': '虹橋',
        '首爾仁川': '仁川',
        '首爾金浦': '金浦'
      };
      
      return simplifications[location] || location;
    }
    
    // JSONP 載入方式（備用）
    function loadWithJSONP() {
      console.log('開始 JSONP 請求...');
      updateProgress(10, '建立連線...');
      
      // 建立 JSONP 回調函數
      const callbackName = 'flightDataCallback_' + Date.now();
      let timeoutId;
      
      window[callbackName] = function(result) {
        console.log('收到 JSONP 回應:', result);
        
        // 清除超時定時器
        if (timeoutId) {
          clearTimeout(timeoutId);
        }
        
        try {
          if (result && result.success) {
            console.log('成功載入航班資料:', result.data);
            
            // 更新進度到85%
            updateProgress(85, '格式化時間資料...');
            
            // 檢查資料結構
            if (!result.data || !result.data.flights) {
              throw new Error('資料格式不正確：缺少 flights 陣列');
            }
            
            // 在前端修正時間格式
            const flights = result.data.flights.map(flight => ({
              ...flight,
              deptTime: formatTimeOnFrontend(flight.deptTime),
              arrTime: formatTimeOnFrontend(flight.arrTime)
            }));
            
            console.log(`前端格式化後的航班資料: ${flights.length} 筆`, flights);
            
            // 更新進度到95%並立即處理
            updateProgress(95, '生成日曆...');
            
            // 減少延遲，更快完成
            setTimeout(() => {
              updateCalendarWithFlights(flights);
              updateFlightList(flights);
              hideLoading();
            }, 100);
            
          } else {
            console.error('載入航班資料失敗:', result);
            const errorMsg = (result && result.data && result.data.error) ? result.data.error : '未知錯誤';
            showConnectionError(`伺服器回應錯誤: ${errorMsg}`);
          }
        } catch (error) {
          console.error('處理資料錯誤:', error);
          showConnectionError(`資料處理錯誤: ${error.message}`);
        } finally {
          // 清理回調函數和 script 標籤
          delete window[callbackName];
          if (script && script.parentNode) {
            document.head.removeChild(script);
          }
        }
      };
      
      // 建立 script 標籤
      const script = document.createElement('script');
      script.src = `${APPS_SCRIPT_URL}?action=getFlights&callback=${callbackName}`;
      
      console.log('JSONP 請求 URL:', script.src);
      updateProgress(20, '發送請求...');
      
      script.onerror = function() {
        console.error('JSONP script 載入失敗');
        if (timeoutId) clearTimeout(timeoutId);
        
        delete window[callbackName];
        if (script && script.parentNode) {
          document.head.removeChild(script);
        }
        
        hideLoading();
        showConnectionError('JSONP script 載入失敗 - 請檢查 Apps Script URL 是否正確');
      };
      
      // 設定超時（縮短為 8 秒，更快反應）
      timeoutId = setTimeout(() => {
        if (window[callbackName]) {
          console.error('JSONP 請求超時');
          console.log('請求 URL:', script.src);
          
          delete window[callbackName];
          if (script && script.parentNode) {
            document.head.removeChild(script);
          }
          
          hideLoading();
          showConnectionError('JSONP 請求超時（8秒） - 請檢查網路連線或 Apps Script 設定');
        }
      }, 8000); // 8秒超時
      
      // 載入進度模擬
      updateProgress(30, '等待伺服器回應...');
      setTimeout(() => {
        if (window[callbackName]) {
          updateProgress(50, '處理中...');
        }
      }, 1000);
      
      document.head.appendChild(script);
    }
    
    // 移除 Fetch 備用方案，專注於 JSONP
    // JSONP 是避免 CORS 問題的最佳解決方案
    
    // 顯示連線錯誤
    function showConnectionError(errorMessage = '') {
      const calendarWrap = document.querySelector('.calendar-wrap');
      
      calendarWrap.innerHTML = `
        <div style="text-align:center;padding:40px;color:#ef4444;">
          <div style="font-size:18px;margin-bottom:8px;">載入失敗</div>
          <div style="font-size:14px;color:#6b7280;margin-bottom:16px;">無法從 Google Sheets 載入航班資料</div>
        </div>
      `;
    }
    
    // 測試直接 CSV 連結
    function testDirectCSV() {
      console.log('測試 CSV 連結:', SHEETS_CSV_URL);
      
      fetch(SHEETS_CSV_URL)
        .then(response => {
          if (response.ok) {
            return response.text();
          }
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        })
        .then(csvText => {
          const lines = csvText.split('\n');
          const preview = lines.slice(0, 5).join('\n');
          console.log('CSV 測試成功:', csvText.substring(0, 200));
          
          alert(`✅ CSV 連結測試成功！\n\n資料預覽:\n${preview}\n\n總行數: ${lines.length}\n\n如果看到航班資料，請點擊「重新載入」`);
        })
        .catch(error => {
          console.error('CSV 測試失敗:', error);
          alert(`❌ CSV 連結測試失敗\n\n錯誤: ${error.message}\n\n請確認：\n1. Google Sheets 已發布到網路\n2. 網路連線正常\n3. 嘗試在新視窗直接開啟 CSV 連結`);
          
          // 自動開啟 CSV 連結讓用戶檢查
          window.open(SHEETS_CSV_URL, '_blank');
        });
    }
    
    // 更新日曆顯示
    function updateCalendarWithFlights(flights) {
      // 清除現有的日曆
      const calendarWrap = document.querySelector('.calendar-wrap');
      calendarWrap.innerHTML = '';
      
      if (flights.length === 0) {
        calendarWrap.innerHTML = '<p style="text-align:center;padding:40px;color:#6b7280;">目前沒有航班資料</p>';
        return;
      }
      
      // 按月份分組航班
      const flightsByMonth = {};
      flights.forEach(flight => {
        const monthKey = flight.date.substring(0, 7); // YYYY-MM
        if (!flightsByMonth[monthKey]) {
          flightsByMonth[monthKey] = [];
        }
        flightsByMonth[monthKey].push(flight);
      });
      
      // 按時間順序排序月份
      const sortedMonths = Object.keys(flightsByMonth).sort();
      
      // 為每個有航班的月份生成日曆
      sortedMonths.forEach(monthKey => {
        const monthFlights = flightsByMonth[monthKey];
        const [year, month] = monthKey.split('-');
        const monthSection = generateMonthCalendar(parseInt(year), parseInt(month), monthFlights);
        calendarWrap.appendChild(monthSection);
      });
    }
    
    // 生成單月日曆
    function generateMonthCalendar(year, month, flights) {
      const monthNames = ['', '一月', '二月', '三月', '四月', '五月', '六月', '七月', '八月', '九月', '十月', '十一月', '十二月'];
      const daysInMonth = new Date(year, month, 0).getDate();
      const firstDay = new Date(year, month - 1, 1).getDay(); // 0=Sunday, 1=Monday, ...
      
      // 建立航班索引
      const flightsByDate = {};
      flights.forEach(flight => {
        const day = parseInt(flight.date.split('-')[2]);
        if (!flightsByDate[day]) {
          flightsByDate[day] = [];
        }
        flightsByDate[day].push(flight);
      });
      
      const section = document.createElement('section');
      section.className = 'month';
      section.id = `m-${year}-${String(month).padStart(2, '0')}`;
      
      // 月份標題
      const header = document.createElement('header');
      header.className = 'month-header';
      header.innerHTML = `<h2>${year} 年 ${monthNames[month]}</h2>`;
      section.appendChild(header);
      
      // 星期標題
      const weekHeader = document.createElement('div');
      weekHeader.className = 'grid header';
      weekHeader.innerHTML = '<div>日</div><div>一</div><div>二</div><div>三</div><div>四</div><div>五</div><div>六</div>';
      section.appendChild(weekHeader);
      
      // 日期格子
      const bodyGrid = document.createElement('div');
      bodyGrid.className = 'grid body';
      
      // 前面的空白格子
      for (let i = 0; i < firstDay; i++) {
        const blankCell = document.createElement('div');
        blankCell.className = 'cell blank';
        bodyGrid.appendChild(blankCell);
      }
      
      // 取得今天的日期
      const today = new Date();
      const todayYear = today.getFullYear();
      const todayMonth = today.getMonth() + 1;
      const todayDay = today.getDate();
      
      // 日期格子
      for (let day = 1; day <= daysInMonth; day++) {
        const cell = document.createElement('div');
        const hasFlights = flightsByDate[day] && flightsByDate[day].length > 0;
        const isToday = year === todayYear && month === todayMonth && day === todayDay;
        
        // 設定 cell 的 class
        let cellClass = 'cell';
        if (hasFlights) cellClass += ' has-event';
        if (isToday) cellClass += ' today';
        cell.className = cellClass;
        
        const dateDiv = document.createElement('div');
        dateDiv.className = isToday ? 'date today' : 'date';
        dateDiv.textContent = day;
        cell.appendChild(dateDiv);
        
        // 添加航班事件
        if (hasFlights) {
          flightsByDate[day].forEach(flight => {
            const eventEl = document.createElement('div');
            eventEl.className = 'event';
            eventEl.id = `d-${flight.date}`;
            
            eventEl.innerHTML = `
              <div class="event-compact">
                <div class="time">${flight.deptTime}</div>
                <div class="route">${flight.departureShort} → ${flight.arrivalShort}</div>
              </div>
              <div class="event-full">
                <div class="airline">${flight.airline} ${flight.airlineEn}</div>
                <div class="route">${flight.departure} → ${flight.arrival}</div>
                <div class="meta">${flight.deptTime} → ${flight.arrTime} ・ ${flight.flightNo}</div>
              </div>
            `;
            
            cell.appendChild(eventEl);
          });
        }
        
        bodyGrid.appendChild(cell);
      }
      
      // 後面的空白格子（讓最後一行填滿）
      const totalCells = firstDay + daysInMonth;
      const remainingCells = 7 - (totalCells % 7);
      if (remainingCells < 7) {
        for (let i = 0; i < remainingCells; i++) {
          const blankCell = document.createElement('div');
          blankCell.className = 'cell blank';
          bodyGrid.appendChild(blankCell);
        }
      }
      
      section.appendChild(bodyGrid);
      return section;
    }
    
    // 更新航班清單
    function updateFlightList(flights) {
      const listContainer = document.querySelector('#flightList');
      if (!listContainer) return;
      
      // 清除所有內容
      listContainer.innerHTML = '';
      
      // 重新加入標題
      const title = document.createElement('h2');
      title.textContent = '航班清單';
      listContainer.appendChild(title);
      
      if (flights.length === 0) {
        const noDataMsg = document.createElement('div');
        noDataMsg.style.cssText = 'padding: 20px; color: #6b7280; font-size: 14px; text-align: center;';
        noDataMsg.textContent = '目前沒有航班資料';
        listContainer.appendChild(noDataMsg);
        return;
      }
      
      flights.forEach(flight => {
        const cardEl = document.createElement('a');
        cardEl.className = 'card';
        cardEl.href = `#d-${flight.date}`;
        cardEl.onclick = closeListOnMobile;
        
        cardEl.innerHTML = `
          <div class="date-tag">${flight.date}</div>
          <div class="airline">${flight.airline} ${flight.airlineEn}</div>
          <div class="route">${flight.departure} → ${flight.arrival}</div>
          <div class="meta">${flight.deptTime} → ${flight.arrTime} ・ ${flight.flightNo}</div>
        `;
        
        listContainer.appendChild(cardEl);
      });
    }
    
    // 頁面載入時自動載入資料
    document.addEventListener('DOMContentLoaded', () => {
      console.log('DOM 載入完成，強制使用 API 載入航班資料');
      
      // 移除靜態資料檢測，強制使用 API
      loadFlightsFromGAS();
    });
    
    // 備用：如果 DOMContentLoaded 沒觸發，使用 window.onload
    window.addEventListener('load', () => {
      console.log('Window 載入完成');
      // 檢查載入動畫是否還在顯示
      setTimeout(() => {
        const loadingModal = document.getElementById('loadingModal');
        if (loadingModal && loadingModal.classList.contains('show')) {
          console.log('載入動畫仍在顯示，嘗試自動關閉');
          hideLoading();
          
          // 顯示提示訊息
          const calendarWrap = document.querySelector('.calendar-wrap');
          if (calendarWrap && calendarWrap.innerHTML.trim() === '') {
            calendarWrap.innerHTML = `
              <div style="text-align:center;padding:40px;color:#6b7280;">
                <div style="font-size:16px;margin-bottom:8px;">載入完成</div>
                <div style="font-size:14px;">如果沒有看到航班資料，請點擊重新載入</div>
                <button onclick="loadFlightsFromGAS()" style="margin-top:16px;padding:8px 16px;background:#1d4ed8;color:white;border:none;border-radius:6px;cursor:pointer;">重新載入</button>
              </div>
            `;
          }
        }
      }, 3000);
    });
  </script>
</body>
</html>
