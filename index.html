<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>é£›è¡Œè¡Œäº‹æ›†</title>
<link rel="manifest" href="manifest.json" />
<meta name="theme-color" content="#1d4ed8" />
<meta name="mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="default" />
<meta name="apple-mobile-web-app-title" content="My Flights" />
<link rel="apple-touch-icon" href="icon.svg" />
<style>
  :root{
    --bg:#ffffff; --text:#111827; --muted:#6b7280; --line:#e5e7eb;
    --event:#eef2ff; --brand:#1d4ed8; --card:#f9fafb;
    --header-h:44px; --nav-h:56px;
  }
  html,body{background:var(--bg);color:var(--text);margin:0}
  body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","PingFang TC","Noto Sans TC",Roboto,"Helvetica Neue",Arial,"Microsoft JhengHei",sans-serif}

  /* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  header{position:sticky;top:0;z-index:30;background:#fff;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;padding:0 14px;height:var(--header-h);box-sizing:border-box}
  header h1{margin:0;font-size:18px}
  .refresh-btn{background:none;border:none;cursor:pointer;padding:4px;display:flex;align-items:center;justify-content:center;opacity:0.7;transition:opacity 0.2s}
  .refresh-btn:hover{opacity:1}
  .refresh-btn:disabled{opacity:0.3;cursor:default}
  .refresh-btn.spinning svg{animation:refresh-spin 0.8s linear infinite}
  .refresh-btn:disabled{opacity:0.7;cursor:default}
  @keyframes refresh-spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
  .list-spinner{width:36px;height:36px;border:4px solid #e5e7eb;border-top-color:#1d4ed8;border-radius:50%;animation:refresh-spin 0.7s linear infinite;margin:0 auto}

  /* â”€â”€ Panels â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .panel{display:none;padding-bottom:calc(var(--nav-h) + env(safe-area-inset-bottom,0px))}
  .panel.active{display:block}

  /* â”€â”€ Calendar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .calendar-wrap{padding:0}
  .month{border-top:1px solid var(--line)}
  .month:first-of-type{border-top:none}
  .month-header{position:sticky;top:var(--header-h);background:rgba(255,255,255,.95);backdrop-filter:saturate(180%) blur(8px);border-bottom:1px solid var(--line);padding:8px 10px;z-index:10}
  .month-header h2{margin:0;font-size:16px}
  .grid{display:grid;grid-template-columns:repeat(7,minmax(0,1fr))}
  .grid.header>div{padding:6px;text-align:center;font-size:11px;color:#6b7280;border-bottom:1px solid var(--line);border-right:1px solid var(--line);background:#fafafa}
  .grid.header>div:nth-child(7n){border-right:none}
  .cell{min-height:80px;border-right:1px solid var(--line);border-bottom:1px solid var(--line);padding:5px;display:flex;flex-direction:column;gap:4px;background:#fff}
  .cell:nth-child(7n){border-right:none}
  .cell.blank{background:#fff}
  .date{font-size:12px;color:#9ca3af}
  .date.today{background:#1d4ed8;color:#fff;border-radius:50%;width:22px;height:22px;display:flex;align-items:center;justify-content:center;font-weight:600;font-size:11px}
  .cell.today{background:linear-gradient(135deg,#f0f7ff 0%,#e0f0ff 100%)}
  .event{background:var(--event);border:1px solid #c7d2fe;border-radius:7px;padding:4px 5px;line-height:1.3;word-wrap:break-word;overflow-wrap:break-word;min-width:0;cursor:pointer;-webkit-tap-highlight-color:transparent}
  .event:active{background:#c7d2fe}
  .event .etime{font-weight:700;font-size:11px;color:#4338ca}
  .event .eroute{font-size:11px;color:#374151;margin-top:1px}
  .event-full{display:none}
  .has-event{background:linear-gradient(180deg,#ffffff 0%,#ffffff 65%,#f3f6ff 100%)}
  .cell.today.has-event{background:linear-gradient(135deg,#f0f7ff 0%,#e0f0ff 100%)}

  /* â”€â”€ List panels â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .list-wrap{padding:12px}
  .lcard{border:1px solid var(--line);border-radius:12px;background:var(--card);padding:12px 14px;margin-bottom:10px;cursor:pointer;-webkit-tap-highlight-color:transparent;transition:background 0.15s}
  .lcard:active{background:#eef2ff;border-color:#c7d2fe}
  .lcard.departed{opacity:0.5}
  .lcard .date-tag{font-size:12px;color:#6b7280;margin-bottom:3px}
  .lcard .airline{font-weight:600;color:#1d4ed8;font-size:14px}
  .lcard .route{font-size:13px;margin-top:3px}
  .lcard .meta{font-size:12px;color:#374151;margin-top:3px}
  .list-empty{padding:48px 20px;text-align:center;color:#6b7280;font-size:14px}

  /* â”€â”€ Bottom nav â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .bottom-nav{position:fixed;bottom:0;left:0;right:0;height:calc(var(--nav-h) + env(safe-area-inset-bottom,0px));background:#fff;border-top:1px solid var(--line);display:flex;z-index:30}
  .bn-item{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;background:none;border:none;cursor:pointer;font-size:10px;color:#6b7280;gap:3px;position:relative;padding:0 0 env(safe-area-inset-bottom,0px);-webkit-tap-highlight-color:transparent}
  .bn-item.active{color:var(--brand)}
  .bn-item svg{width:22px;height:22px;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round}
  .bn-badge{position:absolute;top:5px;right:calc(50% - 22px);min-width:16px;height:16px;padding:0 4px;border-radius:999px;background:#ef4444;color:#fff;font-size:10px;font-weight:700;display:flex;align-items:center;justify-content:center;box-sizing:border-box}
  .bn-badge[data-count="0"]{display:none}

  /* â”€â”€ Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:50;display:none;align-items:center;justify-content:center;padding:20px;box-sizing:border-box}
  .modal-overlay.show{display:flex}
  .modal-content{background:#fff;border-radius:16px;padding:20px;width:100%;max-width:320px;box-shadow:0 20px 25px -5px rgba(0,0,0,0.1),0 10px 10px -5px rgba(0,0,0,0.04);transform:scale(0.9);transition:transform 0.2s ease}
  .modal-overlay.show .modal-content{transform:scale(1)}
  .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid var(--line)}
  .modal-title{font-size:16px;font-weight:600;color:var(--text)}
  .modal-close{background:none;border:none;font-size:24px;color:#9ca3af;cursor:pointer;padding:0;width:32px;height:32px;display:flex;align-items:center;justify-content:center}
  .modal-close:hover{color:var(--text)}
  .modal-body .m-airline{font-weight:600;color:#1d4ed8;font-size:15px;margin-bottom:8px}
  .modal-body .m-route{font-size:14px;margin-bottom:6px;color:var(--text)}
  .modal-body .m-meta{font-size:13px;color:#6b7280;margin-bottom:4px}

  /* â”€â”€ Loading â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .inline-loading{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:calc(100vh - 120px);padding:40px}
  .loading-text{font-size:13px;color:#6b7280;font-weight:500;margin-top:14px}
  .circle-progress{position:relative;width:80px;height:80px;margin:0 auto}
  .circle-progress svg{transform:rotate(-90deg)}
  .cp-track{fill:none;stroke:#e5e7eb;stroke-width:6}
  .cp-ring{fill:none;stroke:#1d4ed8;stroke-width:6;stroke-linecap:round;stroke-dasharray:213.6;stroke-dashoffset:213.6;transition:stroke-dashoffset 0.25s ease}
  .cp-pct{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:17px;font-weight:700;color:#1d4ed8;line-height:1}

  /* â”€â”€ Pull-to-refresh â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .ptr-indicator{position:fixed;top:var(--header-h);left:50%;transform:translateX(-50%) translateY(-60px);width:40px;height:40px;background:#fff;border:1px solid var(--line);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px;box-shadow:0 2px 8px rgba(0,0,0,0.15);z-index:25;pointer-events:none;opacity:0}
  .ptr-indicator.spinning{animation:ptr-spin 0.8s linear infinite}
  @keyframes ptr-spin{
    from{transform:translateX(-50%) translateY(10px) rotate(0deg)}
    to{transform:translateX(-50%) translateY(10px) rotate(360deg)}
  }
</style>
</head>
<body>
  <div id="ptrIndicator" class="ptr-indicator">ğŸ”„</div>

  <header>
    <h1>My Flights</h1>
    <button id="refreshBtn" class="refresh-btn" aria-label="é‡æ–°æ•´ç†">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M3 12a9 9 0 0 1 15-6.7L21 8"/>
        <path d="M21 3v5h-5"/>
        <path d="M21 12a9 9 0 0 1-15 6.7L3 16"/>
        <path d="M3 21v-5h5"/>
      </svg>
    </button>
  </header>

  <!-- Calendar panel -->
  <div id="panelCalendar" class="panel active">
    <div class="calendar-wrap"></div>
  </div>

  <!-- Upcoming panel -->
  <div id="panelUpcoming" class="panel">
    <div class="list-wrap" id="listUpcoming"></div>
  </div>

  <!-- Departed panel -->
  <div id="panelDeparted" class="panel">
    <div class="list-wrap" id="listDeparted"></div>
  </div>

  <!-- Bottom nav -->
  <nav class="bottom-nav">
    <button class="bn-item active" data-panel="panelCalendar">
      <svg viewBox="0 0 24 24">
        <rect x="3" y="4" width="18" height="18" rx="2"/>
        <line x1="16" y1="2" x2="16" y2="6"/>
        <line x1="8" y1="2" x2="8" y2="6"/>
        <line x1="3" y1="10" x2="21" y2="10"/>
      </svg>
      è¡Œäº‹æ›†
    </button>
    <button class="bn-item" data-panel="panelUpcoming">
      <span class="bn-badge" id="badgeUpcoming" data-count="0">0</span>
      <svg viewBox="0 0 24 24">
        <line x1="22" y1="2" x2="11" y2="13"/>
        <polygon points="22 2 15 22 11 13 2 9 22 2"/>
      </svg>
      å¾…å‡ºç™¼
    </button>
    <button class="bn-item" data-panel="panelDeparted">
      <svg viewBox="0 0 24 24">
        <polyline points="20 6 9 17 4 12"/>
      </svg>
      å·²å‡ºç™¼
    </button>
  </nav>

  <!-- Modal -->
  <div id="flightModal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">èˆªç­è©³æƒ…</div>
        <button class="modal-close" id="closeModal">Ã—</button>
      </div>
      <div class="modal-body" id="modalBody"></div>
    </div>
  </div>

  <script>
    const SHEETS_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQqkpj4xzdNRa2qC30VjkGq-eLJcbrv-hPRKa6si93WEFsekexY4EYXnPiZJVWldHRHrG4lR-cyKBbP/pub?gid=665636533&single=true&output=csv';

    let isLoading = false;
    let currentPanel = 'panelCalendar';

    // â”€â”€ Bottom nav â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function switchPanel(panelId) {
      if (panelId === currentPanel) return;
      document.getElementById(currentPanel).classList.remove('active');
      document.getElementById(panelId).classList.add('active');
      document.querySelectorAll('.bn-item').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.panel === panelId);
      });
      currentPanel = panelId;
      window.scrollTo(0, 0);
    }

    document.querySelectorAll('.bn-item').forEach(btn => {
      btn.addEventListener('click', () => switchPanel(btn.dataset.panel));
    });

    // â”€â”€ Refresh button â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.getElementById('refreshBtn').addEventListener('click', loadFlightsFromGAS);

    // â”€â”€ Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const modal = document.getElementById('flightModal');
    const modalBody = document.getElementById('modalBody');

    function showFlightModal(flight) {
      modalBody.innerHTML = `
        <div class="m-airline">${flight.airline} ${flight.airlineEn}</div>
        <div class="m-route">${flight.departure} â†’ ${flight.arrival}</div>
        <div class="m-meta">${flight.date}</div>
        <div class="m-meta">${flight.deptTime} â†’ ${flight.arrTime}</div>
        <div class="m-meta">èˆªç­ï¼š${flight.flightNo}</div>
      `;
      modal.classList.add('show');
      document.body.style.overflow = 'hidden';
    }

    function hideModal() {
      modal.classList.remove('show');
      document.body.style.overflow = '';
    }

    document.getElementById('closeModal').addEventListener('click', hideModal);
    modal.addEventListener('click', e => { if (e.target === modal) hideModal(); });
    document.addEventListener('keydown', e => { if (e.key === 'Escape') hideModal(); });

    // â”€â”€ Loading â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let progressInterval;

    function startRefreshSpin() {
      const btn = document.getElementById('refreshBtn');
      if (btn) { btn.disabled = true; btn.classList.add('spinning'); }
    }

    function stopRefreshSpin() {
      const btn = document.getElementById('refreshBtn');
      if (btn) { btn.disabled = false; btn.classList.remove('spinning'); }
      if (window._ptrHide) window._ptrHide();
    }

    function showLoading() {
      isLoading = true;
      const calendarWrap = document.querySelector('#panelCalendar .calendar-wrap');
      calendarWrap.innerHTML = `
        <div class="inline-loading">
          <div class="circle-progress">
            <svg viewBox="0 0 80 80" width="80" height="80">
              <circle class="cp-track" cx="40" cy="40" r="34"/>
              <circle class="cp-ring" id="progressRing" cx="40" cy="40" r="34"/>
            </svg>
            <div class="cp-pct" id="progressPct">0%</div>
          </div>
          <div class="loading-text" id="progressText">æ­£åœ¨é€£æ¥...</div>
        </div>`;
      ['listUpcoming', 'listDeparted'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.innerHTML = '<div class="inline-loading"><div class="list-spinner"></div></div>';
      });
      startRefreshSpin();

      let progress = 0;
      progressInterval = setInterval(() => {
        if (progress < 30) {
          progress += Math.random() * 8 + 2;
          updateProgress(progress, 'æ­£åœ¨é€£æ¥ Google Sheets...');
        } else if (progress < 70) {
          progress += Math.random() * 5 + 1;
          updateProgress(progress, 'è®€å–èˆªç­è³‡æ–™...');
        } else if (progress < 85) {
          progress += Math.random() * 2 + 0.5;
          updateProgress(progress, 'è™•ç†è³‡æ–™æ ¼å¼...');
        }
      }, 50);
    }

    function updateProgress(percent, message) {
      const ring = document.getElementById('progressRing');
      const pct = document.getElementById('progressPct');
      const text = document.getElementById('progressText');
      const circumference = 213.6;
      if (ring) ring.style.strokeDashoffset = circumference * (1 - Math.min(percent, 100) / 100);
      if (pct) pct.textContent = Math.round(Math.min(percent, 100)) + '%';
      if (text && message) text.textContent = message;
    }

    function hideLoading() {
      isLoading = false;
      if (progressInterval) { clearInterval(progressInterval); progressInterval = null; }
      stopRefreshSpin();
    }

    // â”€â”€ Data loading â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function loadFlightsFromGAS() {
      showLoading();
      updateProgress(10, 'é€£æ¥ Google Sheets...');

      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 20000);

      fetch(SHEETS_CSV_URL, { signal: controller.signal })
        .then(response => {
          updateProgress(30, 'ä¸‹è¼‰è³‡æ–™...');
          if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          return response.text();
        })
        .then(csvText => {
          updateProgress(60, 'è§£æ CSV è³‡æ–™...');
          const flights = parseCSVToFlights(csvText);
          if (flights.length === 0) throw new Error('è§£æå¾Œæ²’æœ‰æ‰¾åˆ°ä»»ä½•èˆªç­è³‡æ–™');
          updateProgress(85, 'æ ¼å¼åŒ–æ™‚é–“è³‡æ–™...');

          const formattedFlights = flights.map(f => ({
            ...f,
            deptTime: formatTimeOnFrontend(f.deptTime),
            arrTime: formatTimeOnFrontend(f.arrTime)
          }));

          updateProgress(95, 'ç”Ÿæˆæ—¥æ›†...');
          clearTimeout(timeoutId);

          setTimeout(() => {
            updateCalendarWithFlights(formattedFlights);
            updateFlightList(formattedFlights);
            hideLoading();
            const todayCell = document.getElementById('today');
            if (todayCell) todayCell.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }, 100);
        })
        .catch(error => {
          clearTimeout(timeoutId);
          console.error('è¼‰å…¥å¤±æ•—:', error);
          hideLoading();

          const isNetworkError =
            error.message.includes('Failed to fetch') ||
            error.message.includes('Load failed') ||
            error.message.includes('NetworkError') ||
            error.message.includes('FetchEvent.respondWith');

          if (error.name === 'AbortError') {
            showConnectionError('é€£ç·šé€¾æ™‚ï¼ˆ20 ç§’ï¼‰ï¼Œè«‹æª¢æŸ¥ç¶²è·¯å¾Œé‡è©¦ã€‚');
          } else if (isNetworkError) {
            showConnectionError('ç¶²è·¯é€£ç·šå¤±æ•—ï¼Œè«‹ç¢ºèªç¶²è·¯é€£ç·šå¾Œé‡è©¦ã€‚');
          } else {
            showConnectionError(`è¼‰å…¥éŒ¯èª¤: ${error.message}`);
          }
        });
    }

    // â”€â”€ CSV parsing â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function parseCSVToFlights(csvText) {
      const lines = csvText.trim().split('\n');
      const flights = [];
      for (let i = 1; i < lines.length; i++) {
        const line = lines[i].trim();
        if (!line) continue;
        const values = parseCSVLine(line);
        if (!values[0]) continue;
        flights.push({
          date: formatDate(values[0]),
          airline: values[1] || '',
          departure: values[2] || '',
          arrival: values[3] || '',
          deptTime: values[4] || '',
          arrTime: values[5] || '',
          flightNo: values[6] || '',
          airlineEn: values[7] || '',
          departureShort: simplifyLocation(values[2]),
          arrivalShort: simplifyLocation(values[3])
        });
      }
      flights.sort((a, b) => new Date(a.date) - new Date(b.date));
      return flights;
    }

    function parseCSVLine(line) {
      const values = [];
      let current = '';
      let inQuotes = false;
      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        if (char === '"') { inQuotes = !inQuotes; }
        else if (char === ',' && !inQuotes) { values.push(current.trim()); current = ''; }
        else { current += char; }
      }
      values.push(current.trim());
      return values;
    }

    function formatDate(date) {
      if (!date) return '';
      if (/^\d{4}-\d{2}-\d{2}$/.test(date)) return date;
      const d = new Date(date);
      if (isNaN(d.getTime())) return date.toString();
      return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    }

    function simplifyLocation(location) {
      if (!location) return '';
      const m = {'å°åŒ—æ¡ƒåœ’':'æ¡ƒåœ’','å°åŒ—æ¾å±±':'æ¾å±±','ä¸Šæµ·æµ¦æ±':'æµ¦æ±','ä¸Šæµ·è™¹æ©‹':'è™¹æ©‹','é¦–çˆ¾ä»å·':'ä»å·','é¦–çˆ¾é‡‘æµ¦':'é‡‘æµ¦'};
      return m[location] || location;
    }

    function formatTimeOnFrontend(timeStr) {
      if (!timeStr) return '';
      if (/^\d{1,2}:\d{2}$/.test(timeStr)) return timeStr;
      if (typeof timeStr === 'string' && timeStr.includes('T')) {
        try {
          const date = new Date(timeStr);
          if (!isNaN(date.getTime())) {
            if (date.getFullYear() === 1899) {
              let h = date.getUTCHours() + 8;
              if (h >= 24) h -= 24;
              return `${String(h).padStart(2,'0')}:${String(date.getUTCMinutes()).padStart(2,'0')}`;
            } else {
              return `${String(date.getHours()).padStart(2,'0')}:${String(date.getMinutes()).padStart(2,'0')}`;
            }
          }
        } catch(e) {}
      }
      return timeStr;
    }

    // â”€â”€ Calendar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function updateCalendarWithFlights(flights) {
      const calendarWrap = document.querySelector('#panelCalendar .calendar-wrap');
      calendarWrap.innerHTML = '';
      if (flights.length === 0) {
        calendarWrap.innerHTML = '<p style="text-align:center;padding:40px;color:#6b7280;">ç›®å‰æ²’æœ‰èˆªç­è³‡æ–™</p>';
        return;
      }
      const flightsByMonth = {};
      flights.forEach(f => {
        const k = f.date.substring(0, 7);
        if (!flightsByMonth[k]) flightsByMonth[k] = [];
        flightsByMonth[k].push(f);
      });
      Object.keys(flightsByMonth).sort().forEach(monthKey => {
        const [year, month] = monthKey.split('-');
        calendarWrap.appendChild(generateMonthCalendar(parseInt(year), parseInt(month), flightsByMonth[monthKey]));
      });
    }

    function generateMonthCalendar(year, month, flights) {
      const monthNames = ['','ä¸€æœˆ','äºŒæœˆ','ä¸‰æœˆ','å››æœˆ','äº”æœˆ','å…­æœˆ','ä¸ƒæœˆ','å…«æœˆ','ä¹æœˆ','åæœˆ','åä¸€æœˆ','åäºŒæœˆ'];
      const daysInMonth = new Date(year, month, 0).getDate();
      const firstDay = new Date(year, month - 1, 1).getDay();

      const flightsByDate = {};
      flights.forEach(f => {
        const day = parseInt(f.date.split('-')[2]);
        if (!flightsByDate[day]) flightsByDate[day] = [];
        flightsByDate[day].push(f);
      });

      const section = document.createElement('section');
      section.className = 'month';
      section.id = `m-${year}-${String(month).padStart(2,'0')}`;

      const hdr = document.createElement('header');
      hdr.className = 'month-header';
      hdr.innerHTML = `<h2>${year} å¹´ ${monthNames[month]}</h2>`;
      section.appendChild(hdr);

      const weekHdr = document.createElement('div');
      weekHdr.className = 'grid header';
      weekHdr.innerHTML = '<div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div>';
      section.appendChild(weekHdr);

      const bodyGrid = document.createElement('div');
      bodyGrid.className = 'grid body';

      for (let i = 0; i < firstDay; i++) {
        const blank = document.createElement('div');
        blank.className = 'cell blank';
        bodyGrid.appendChild(blank);
      }

      const today = new Date();
      const ty = today.getFullYear(), tm = today.getMonth() + 1, td = today.getDate();

      for (let day = 1; day <= daysInMonth; day++) {
        const cell = document.createElement('div');
        const dayFlights = flightsByDate[day];
        const hasFlights = !!(dayFlights && dayFlights.length > 0);
        const isToday = year === ty && month === tm && day === td;

        cell.className = 'cell' + (hasFlights ? ' has-event' : '') + (isToday ? ' today' : '');
        if (isToday) cell.id = 'today';

        const dateDiv = document.createElement('div');
        dateDiv.className = isToday ? 'date today' : 'date';
        dateDiv.textContent = day;
        cell.appendChild(dateDiv);

        if (hasFlights) {
          dayFlights.forEach(flight => {
            const eventEl = document.createElement('div');
            eventEl.className = 'event';
            eventEl.id = `d-${flight.date}`;
            eventEl.innerHTML = `
              <div class="etime">${flight.deptTime}</div>
              <div class="eroute">${flight.departureShort}â†’${flight.arrivalShort}</div>
            `;
            eventEl.addEventListener('click', e => {
              e.stopPropagation();
              showFlightModal(flight);
            });
            cell.appendChild(eventEl);
          });
        }

        bodyGrid.appendChild(cell);
      }

      const totalCells = firstDay + daysInMonth;
      const remaining = 7 - (totalCells % 7);
      if (remaining < 7) {
        for (let i = 0; i < remaining; i++) {
          const blank = document.createElement('div');
          blank.className = 'cell blank';
          bodyGrid.appendChild(blank);
        }
      }

      section.appendChild(bodyGrid);
      return section;
    }

    // â”€â”€ Flight list â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function updateFlightList(flights) {
      const todayStr = new Date().toISOString().slice(0, 10);
      const upcoming = flights.filter(f => f.date >= todayStr);
      const departed = flights.filter(f => f.date < todayStr).reverse();

      const badgeUp = document.getElementById('badgeUpcoming');
      badgeUp.textContent = upcoming.length;
      badgeUp.dataset.count = upcoming.length;

      buildCards(upcoming, document.getElementById('listUpcoming'), false);
      buildCards(departed, document.getElementById('listDeparted'), true);
    }

    function buildCards(list, container, isDeparted) {
      container.innerHTML = '';
      if (list.length === 0) {
        container.innerHTML = '<div class="list-empty">æ²’æœ‰èˆªç­</div>';
        return;
      }
      list.forEach(flight => {
        const card = document.createElement('div');
        card.className = 'lcard' + (isDeparted ? ' departed' : '');
        card.innerHTML = `
          <div class="date-tag">${flight.date}</div>
          <div class="airline">${flight.airline} ${flight.airlineEn}</div>
          <div class="route">${flight.departure} â†’ ${flight.arrival}</div>
          <div class="meta">${flight.deptTime} â†’ ${flight.arrTime} ãƒ» ${flight.flightNo}</div>
        `;
        card.addEventListener('click', () => {
          switchPanel('panelCalendar');
          setTimeout(() => {
            const target = document.getElementById('d-' + flight.date);
            if (target) target.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }, 50);
        });
        container.appendChild(card);
      });
    }

    function showConnectionError(msg) {
      const calendarWrap = document.querySelector('#panelCalendar .calendar-wrap');
      calendarWrap.innerHTML = `
        <div style="text-align:center;padding:40px;color:#ef4444;">
          <div style="font-size:18px;margin-bottom:8px;">è¼‰å…¥å¤±æ•—</div>
          <div style="font-size:14px;color:#6b7280;margin-bottom:16px;">ç„¡æ³•å¾ Google Sheets è¼‰å…¥èˆªç­è³‡æ–™</div>
          ${msg ? `<div style="font-size:13px;color:#ef4444;background:#fef2f2;border:1px solid #fecaca;border-radius:8px;padding:10px 14px;margin-top:8px;white-space:pre-wrap;text-align:left;">${msg}</div>` : ''}
          <button onclick="loadFlightsFromGAS()" style="margin-top:16px;padding:8px 16px;background:#1d4ed8;color:white;border:none;border-radius:6px;cursor:pointer;">é‡æ–°è¼‰å…¥</button>
        </div>`;
    }

    // â”€â”€ Pull-to-refresh â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    (function() {
      const PTR_THRESHOLD = 70;
      const indicator = document.getElementById('ptrIndicator');
      let startY = 0, pulling = false, triggered = false;

      function setPtrY(dy) {
        const ratio = Math.min(dy / PTR_THRESHOLD, 1);
        const ty = -60 + ratio * 70;
        const rot = ratio * 180;
        indicator.style.transform = `translateX(-50%) translateY(${ty}px) rotate(${rot}deg)`;
        indicator.style.opacity = ratio;
      }

      document.addEventListener('touchstart', e => {
        if (window.scrollY === 0 && currentPanel === 'panelCalendar' && !isLoading) {
          startY = e.touches[0].clientY;
          pulling = true;
          triggered = false;
          indicator.classList.remove('spinning');
        }
      }, { passive: true });

      document.addEventListener('touchmove', e => {
        if (!pulling) return;
        const dy = e.touches[0].clientY - startY;
        if (dy > 0) {
          setPtrY(dy);
          if (dy >= PTR_THRESHOLD && !triggered) {
            triggered = true;
            if (navigator.vibrate) navigator.vibrate(30);
          }
        }
      }, { passive: true });

      document.addEventListener('touchend', () => {
        if (!pulling) return;
        pulling = false;
        if (triggered) {
          indicator.style.transform = 'translateX(-50%) translateY(10px)';
          indicator.classList.add('spinning');
          loadFlightsFromGAS();
        } else {
          indicator.style.transition = 'transform 0.3s ease, opacity 0.3s ease';
          setPtrY(0);
          setTimeout(() => { indicator.style.transition = ''; }, 300);
        }
      }, { passive: true });

      window._ptrHide = function() {
        indicator.classList.remove('spinning');
        indicator.style.transition = 'transform 0.3s ease, opacity 0.3s ease';
        setPtrY(0);
        setTimeout(() => { indicator.style.transition = ''; }, 300);
      };
    })();

    // â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.addEventListener('DOMContentLoaded', loadFlightsFromGAS);

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js').catch(err => {
        console.warn('Service Worker registration failed:', err);
      });
    }
  </script>
</body>
</html>
