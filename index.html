
<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>é£›è¡Œè¡Œäº‹æ›†</title>
<link rel="manifest" href="manifest.json" />
<meta name="theme-color" content="#1d4ed8" />
<meta name="mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="default" />
<meta name="apple-mobile-web-app-title" content="My Flights" />
<link rel="apple-touch-icon" href="icon.svg" />
<style>
  :root{
    --bg:#ffffff; --text:#111827; --muted:#6b7280; --line:#e5e7eb;
    --event:#eef2ff; --brand:#1d4ed8; --card:#f9fafb;
  }
  html,body{background:var(--bg);color:var(--text);margin:0}
  body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","PingFang TC","Noto Sans TC",Roboto,"Helvetica Neue",Arial,"Microsoft JhengHei",sans-serif}
  header{position:sticky;top:0;z-index:30;background:#fff;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;padding:10px 14px}
  header h1{margin:0;font-size:18px}
  .list-btn{font-size:20px;background:none;border:none;cursor:pointer;display:none}
  .refresh-btn{font-size:20px;background:none;border:none;cursor:pointer;line-height:1;transition:opacity 0.2s}
  .refresh-btn:disabled{opacity:0.5;cursor:default}
  .refresh-btn.spinning{animation:spin 0.8s linear infinite}
  @keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
  .container{max-width:1200px;margin:0 auto;display:grid;grid-template-columns:3fr 1fr;gap:0;min-height:calc(100vh - 44px)}
  .calendar-wrap{padding:10px}
  .month{border-top:1px solid var(--line)}
  .month:first-of-type{border-top:none}
  .month-header{position:sticky;top:44px;background:rgba(255,255,255,.95);backdrop-filter:saturate(180%) blur(8px);border-bottom:1px solid var(--line);padding:8px 6px;z-index:10}
  .month-header h2{margin:0;font-size:16px}
  .grid{display:grid;grid-template-columns:repeat(7,minmax(0,1fr))}
  .grid.header>div{padding:6px;text-align:center;font-size:11px;color:#6b7280;border-bottom:1px solid var(--line);border-right:1px solid var(--line);background:#fafafa}
  .grid.header>div:nth-child(7n){border-right:none}
  .cell{min-height:96px;border-right:1px solid var(--line);border-bottom:1px solid var(--line);padding:6px;display:flex;flex-direction:column;gap:6px;background:#fff}
  .cell:nth-child(7n){border-right:none}
  .cell.blank{background:#fff}
  .date{font-size:12px;color:#9ca3af}
  .date.today{background:#1d4ed8;color:#fff;border-radius:50%;width:24px;height:24px;display:flex;align-items:center;justify-content:center;font-weight:600}
  .cell.today{background:linear-gradient(135deg,#f0f7ff 0%,#e0f0ff 100%)}
  .event{background:var(--event);border:1px solid #c7d2fe;border-radius:10px;padding:6px 8px;line-height:1.25;word-wrap:break-word;overflow-wrap:break-word;min-width:0}
  .event .airline{font-weight:700;font-size:12px;color:#4338ca}
  .event .route{font-size:12px;margin-top:2px}
  .event .meta{font-size:11px;color:#374151;margin-top:2px}
  .has-event{background:linear-gradient(180deg,#ffffff 0%,#ffffff 70%,#f3f6ff 100%)}
  .cell.today.has-event{background:linear-gradient(135deg,#f0f7ff 0%,#e0f0ff 100%)}
  /* å³å´åˆ—è¡¨ */
  aside.flight-list{border-left:1px solid var(--line);background:#fff;padding:12px;position:sticky;top:44px;height:calc(100vh - 44px);overflow:auto}
  .flight-list h2{font-size:16px;margin:0 0 10px}
  .flight-list .card{display:block;text-decoration:none;color:inherit;border:1px solid var(--line);border-radius:12px;background:var(--card);padding:10px 12px;margin-bottom:10px}
  .flight-list .card:hover{background:#eef2ff;border-color:#c7d2fe}
  .flight-list .date-tag{font-size:12px;color:#6b7280;margin-bottom:2px}
  .flight-list .airline{font-weight:600;color:#1d4ed8;font-size:13px}
  .flight-list .route{font-size:13px;margin-top:2px}
  .flight-list .meta{font-size:12px;color:#374151;margin-top:2px}
  /* æ‰‹æ©Ÿç‰ˆäº‹ä»¶ç°¡åŒ–é¡¯ç¤º */
  .event-compact{display:none}
  .event-full{display:block}
  
  /* å½ˆçª—æ¨£å¼ */
  .modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:50;display:none;align-items:center;justify-content:center;padding:20px;box-sizing:border-box}
  .modal-overlay.show{display:flex}
  .modal-content{background:#fff;border-radius:16px;padding:20px;width:100%;max-width:320px;box-shadow:0 20px 25px -5px rgba(0,0,0,0.1),0 10px 10px -5px rgba(0,0,0,0.04);transform:scale(0.9);transition:transform 0.2s ease}
  .modal-overlay.show .modal-content{transform:scale(1)}
  .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid var(--line)}
  .modal-title{font-size:16px;font-weight:600;color:var(--text)}
  .modal-close{background:none;border:none;font-size:24px;color:#9ca3af;cursor:pointer;padding:0;width:24px;height:24px;display:flex;align-items:center;justify-content:center}
  .modal-close:hover{color:var(--text)}
  .modal-body .airline{font-weight:600;color:#1d4ed8;font-size:14px;margin-bottom:8px}
  .modal-body .route{font-size:14px;margin-bottom:8px;color:var(--text)}
  .modal-body .meta{font-size:13px;color:#6b7280;margin-bottom:4px}
  .modal-body .time-detail{font-size:13px;color:#374151}
  
  /* å…§åµŒ loadingï¼ˆä¸è“‹ä½ headerï¼‰*/
  .inline-loading{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:calc(100vh - 90px);padding:40px}
  .loading-text{font-size:13px;color:#6b7280;font-weight:500;margin-top:14px}
  /* åœ“å½¢é€²åº¦ç’° */
  .circle-progress{position:relative;width:80px;height:80px;margin:0 auto}
  .circle-progress svg{transform:rotate(-90deg)}
  .cp-track{fill:none;stroke:#e5e7eb;stroke-width:6}
  .cp-ring{fill:none;stroke:#1d4ed8;stroke-width:6;stroke-linecap:round;stroke-dasharray:213.6;stroke-dashoffset:213.6;transition:stroke-dashoffset 0.25s ease}
  .cp-pct{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:17px;font-weight:700;color:#1d4ed8;line-height:1}
  
  /* ä¸‹æ‹‰åˆ·æ–°æŒ‡ç¤ºå™¨ */
  .ptr-indicator{position:fixed;top:44px;left:50%;transform:translateX(-50%) translateY(-60px);width:40px;height:40px;background:#fff;border:1px solid var(--line);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px;box-shadow:0 2px 8px rgba(0,0,0,0.15);transition:transform 0.25s ease,opacity 0.25s ease;z-index:25;pointer-events:none;opacity:0}
  .ptr-indicator.visible{opacity:1}
  .ptr-indicator.spinning{animation:spin 0.8s linear infinite;transform:translateX(-50%) translateY(10px) !important;opacity:1}

  /* æ‰‹æ©Ÿï¼šåˆ—è¡¨æ”¹ç‚ºæŠ½å±œï¼Œicon é¡¯ç¤º */
  @media(max-width:768px){
    .container{grid-template-columns:1fr}
    .list-btn{display:block}
    aside.flight-list{position:fixed;top:0;right:-100%;width:80%;max-width:340px;height:100vh;border-left:1px solid var(--line);box-shadow:-4px 0 16px rgba(0,0,0,.2);transition:right .28s ease;background:#fff;z-index:40}
    aside.flight-list.open{right:0}
    .month-header{top:44px}
    
    /* æ‰‹æ©Ÿç‰ˆäº‹ä»¶ç°¡åŒ–é¡¯ç¤º */
    .event{cursor:pointer;transition:all 0.2s ease}
    .event-compact{display:block;font-size:11px}
    .event-full{display:none}
    .event-compact .time{font-weight:600;color:#4338ca}
    .event-compact .route{margin-top:1px;color:#374151}
  }
</style>
</head>
<body>
  <!-- ä¸‹æ‹‰åˆ·æ–°æŒ‡ç¤ºå™¨ -->
  <div id="ptrIndicator" class="ptr-indicator">ğŸ”„</div>
  <header>
    <h1>My Flights</h1>
    <div style="display:flex;align-items:center;gap:8px">
      <button id="refreshBtn" class="refresh-btn" aria-label="é‡æ–°æ•´ç†">ğŸ”„</button>
      <button id="toggleList" class="list-btn" aria-label="åˆ‡æ›æ¸…å–®">â˜°</button>
    </div>
  </header>
  <div class="container">
    <div class="calendar-wrap">
      <!-- æ—¥æ›†å°‡ç”± API å‹•æ…‹ç”Ÿæˆ -->
    </div>
    <aside id="flightList" class="flight-list">
      <h2>èˆªç­æ¸…å–®</h2>
    </aside>
  </div>
  
  <!-- å½ˆçª— -->
  <div id="flightModal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">èˆªç­è©³æƒ…</div>
        <button class="modal-close" id="closeModal">Ã—</button>
      </div>
      <div class="modal-body" id="modalBody">
        <!-- å‹•æ…‹å…§å®¹ -->
      </div>
    </div>
  </div>
  
  <script>
    // ç›´æ¥ä½¿ç”¨ç™¼å¸ƒåˆ°ç¶²è·¯çš„ CSV é€£çµ
    const SHEETS_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQqkpj4xzdNRa2qC30VjkGq-eLJcbrv-hPRKa6si93WEFsekexY4EYXnPiZJVWldHRHrG4lR-cyKBbP/pub?gid=665636533&single=true&output=csv';
    
    const btn = document.getElementById('toggleList');
    const list = document.getElementById('flightList');
    const refreshBtn = document.getElementById('refreshBtn');

    refreshBtn && refreshBtn.addEventListener('click', () => {
      loadFlightsFromGAS();
    });
    
    btn && btn.addEventListener('click', ()=> list.classList.toggle('open'));
    
    // é»æ“Šé¸å–®å¤–éƒ¨å€åŸŸé—œé–‰é¸å–®
    document.addEventListener('click', (e) => {
      if (window.matchMedia('(max-width: 768px)').matches && list.classList.contains('open')) {
        // å¦‚æœé»æ“Šçš„ä¸æ˜¯é¸å–®æœ¬èº«æˆ–é¸å–®æŒ‰éˆ•
        if (!list.contains(e.target) && !btn.contains(e.target)) {
          list.classList.remove('open');
        }
      }
    });
    
    // å½ˆçª—ç›¸é—œå…ƒç´ 
    const modal = document.getElementById('flightModal');
    const modalBody = document.getElementById('modalBody');
    const closeModal = document.getElementById('closeModal');
    
    // æ‰‹æ©Ÿç‰ˆäº‹ä»¶é»æ“Šé¡¯ç¤ºå½ˆçª—
    document.addEventListener('click', (e) => {
      if (window.matchMedia('(max-width: 768px)').matches) {
        const event = e.target.closest('.event');
        if (event && !e.target.closest('a')) {
          e.preventDefault();
          showFlightModal(event);
        }
      }
    });
    
    // é¡¯ç¤ºå½ˆçª—
    function showFlightModal(eventElement) {
      const fullContent = eventElement.querySelector('.event-full');
      if (fullContent) {
        modalBody.innerHTML = fullContent.innerHTML;
        modal.classList.add('show');
        document.body.style.overflow = 'hidden'; // é˜²æ­¢èƒŒæ™¯æ»¾å‹•
      }
    }
    
    // é—œé–‰å½ˆçª—
    function hideFlightModal() {
      modal.classList.remove('show');
      document.body.style.overflow = ''; // æ¢å¾©æ»¾å‹•
    }
    
    // é»æ“Šé—œé–‰æŒ‰éˆ•
    closeModal.addEventListener('click', hideFlightModal);
    
    // é»æ“Šé®ç½©é—œé–‰
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        hideFlightModal();
      }
    });
    
    // ç·Šæ€¥é—œé–‰è¼‰å…¥å‹•ç•«çš„å¿«æ·éµå’Œé»æ“Š
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        const loadingModal = document.getElementById('loadingModal');
        if (loadingModal && loadingModal.classList.contains('show')) {
          hideLoading();
        }
      }
    });
    
    // é»æ“Šè¼‰å…¥å‹•ç•«é—œé–‰
    document.addEventListener('click', (e) => {
      const loadingModal = document.getElementById('loadingModal');
      if (loadingModal && loadingModal.classList.contains('show') &&
          (e.target === loadingModal || loadingModal.contains(e.target))) {
        hideLoading();
      }
    });
    
    function closeListOnMobile(){
      if (window.matchMedia('(max-width: 768px)').matches){
        list.classList.remove('open');
      }
    }
    
    // é€²åº¦æ¢æ§åˆ¶
    let progressInterval;
    
    // é‡æ–°æ•´ç†æŒ‰éˆ•å‹•ç•«æ§åˆ¶
    function startRefreshSpin() {
      const refreshBtn = document.getElementById('refreshBtn');
      if (refreshBtn) { refreshBtn.classList.add('spinning'); refreshBtn.disabled = true; }
    }
    function stopRefreshSpin() {
      const refreshBtn = document.getElementById('refreshBtn');
      if (refreshBtn) { refreshBtn.classList.remove('spinning'); refreshBtn.disabled = false; }
      if (window._ptrHide) window._ptrHide();
    }

    // é¡¯ç¤ºè¼‰å…¥å‹•ç•«ï¼ˆæ³¨å…¥ calendar-wrapï¼Œheader ä¿æŒå¯è¦‹ï¼‰
    function showLoading() {
      const calendarWrap = document.querySelector('.calendar-wrap');
      const flightList = document.querySelector('#flightList');

      calendarWrap.innerHTML = `
        <div class="inline-loading">
          <div class="circle-progress">
            <svg viewBox="0 0 80 80" width="80" height="80">
              <circle class="cp-track" cx="40" cy="40" r="34"/>
              <circle class="cp-ring" id="progressRing" cx="40" cy="40" r="34"/>
            </svg>
            <div class="cp-pct" id="progressPct">0%</div>
          </div>
          <div class="loading-text" id="progressText">æ­£åœ¨é€£æ¥...</div>
        </div>`;
      flightList.querySelectorAll('.card').forEach(card => card.remove());
      startRefreshSpin();

      // æ¨¡æ“¬é€²åº¦å‹•ç•«
      let progress = 0;
      progressInterval = setInterval(() => {
        if (progress < 30) {
          progress += Math.random() * 8 + 2;
          updateProgress(progress, 'æ­£åœ¨é€£æ¥ Google Sheets...');
        } else if (progress < 70) {
          progress += Math.random() * 5 + 1;
          updateProgress(progress, 'è®€å–èˆªç­è³‡æ–™...');
        } else if (progress < 85) {
          progress += Math.random() * 2 + 0.5;
          updateProgress(progress, 'è™•ç†è³‡æ–™æ ¼å¼...');
        }
      }, 50);
    }

    // æ›´æ–°åœ“å½¢é€²åº¦ç’°
    function updateProgress(percent, message) {
      const ring = document.getElementById('progressRing');
      const pct = document.getElementById('progressPct');
      const text = document.getElementById('progressText');
      const circumference = 213.6;
      if (ring) ring.style.strokeDashoffset = circumference * (1 - Math.min(percent, 100) / 100);
      if (pct) pct.textContent = Math.round(Math.min(percent, 100)) + '%';
      if (text && message) text.textContent = message;
    }
    
    // éš±è—è¼‰å…¥å‹•ç•«ï¼ˆcalendar-wrap å·²ç”± updateCalendarWithFlights è¦†è“‹ï¼‰
    function hideLoading() {
      if (progressInterval) {
        clearInterval(progressInterval);
        progressInterval = null;
      }
      stopRefreshSpin();
    }
    
    // å‰ç«¯æ™‚é–“æ ¼å¼åŒ–å‡½æ•¸ï¼ˆå‚™æ´ï¼‰
    function formatTimeOnFrontend(timeStr) {
      if (!timeStr) return '';
      
      // å¦‚æœå·²ç¶“æ˜¯ HH:MM æ ¼å¼ï¼Œç›´æ¥è¿”å›
      if (/^\d{1,2}:\d{2}$/.test(timeStr)) {
        return timeStr;
      }
      
      // å¦‚æœæ˜¯ ISO æ™‚é–“æ ¼å¼
      if (typeof timeStr === 'string' && timeStr.includes('T')) {
        try {
          const date = new Date(timeStr);
          if (!isNaN(date.getTime())) {
            // å°æ–¼ 1899 å¹´çš„æ—¥æœŸï¼Œé€™æ˜¯ Google Sheets çš„æ™‚é–“æ ¼å¼
            // éœ€è¦åŠ ä¸Š 8 å°æ™‚ä¾†è½‰æ›ç‚ºå°ç£æ™‚é–“ (UTC+8)
            if (date.getFullYear() === 1899) {
              const utcHours = date.getUTCHours();
              const utcMinutes = date.getUTCMinutes();
              
              // åŠ ä¸Š 8 å°æ™‚è½‰æ›ç‚ºå°ç£æ™‚é–“
              let localHours = utcHours + 8;
              let localMinutes = utcMinutes;
              
              // è™•ç†è·¨æ—¥æƒ…æ³
              if (localHours >= 24) {
                localHours -= 24;
              }
              
              return `${String(localHours).padStart(2, '0')}:${String(localMinutes).padStart(2, '0')}`;
            } else {
              // æ­£å¸¸æ—¥æœŸä½¿ç”¨æœ¬åœ°æ™‚é–“
              const hours = date.getHours();
              const minutes = date.getMinutes();
              return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
            }
          }
        } catch (e) {
          console.error('å‰ç«¯æ™‚é–“æ ¼å¼åŒ–å¤±æ•—:', e);
        }
      }
      
      return timeStr;
    }
    
    // å¾ Google Sheets è¼‰å…¥èˆªç­è³‡æ–™ (ä½¿ç”¨ç™¼å¸ƒåˆ°ç¶²è·¯çš„ CSV)
    function loadFlightsFromGAS() {
      showLoading();
      updateProgress(10, 'é€£æ¥ Google Sheets...');

      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 20000); // 20 ç§’è¶…æ™‚

      fetch(SHEETS_CSV_URL, { signal: controller.signal })
        .then(response => {
          updateProgress(30, 'ä¸‹è¼‰è³‡æ–™...');
          
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          return response.text();
        })
        .then(csvText => {
          updateProgress(60, 'è§£æ CSV è³‡æ–™...');
          const flights = parseCSVToFlights(csvText);
          
          if (flights.length === 0) {
            throw new Error('è§£æå¾Œæ²’æœ‰æ‰¾åˆ°ä»»ä½•èˆªç­è³‡æ–™');
          }
          
          updateProgress(85, 'æ ¼å¼åŒ–æ™‚é–“è³‡æ–™...');
          
          // æ ¼å¼åŒ–æ™‚é–“
          const formattedFlights = flights.map(flight => ({
            ...flight,
            deptTime: formatTimeOnFrontend(flight.deptTime),
            arrTime: formatTimeOnFrontend(flight.arrTime)
          }));
          
          updateProgress(95, 'ç”Ÿæˆæ—¥æ›†...');
          
          clearTimeout(timeoutId);
          setTimeout(() => {
            updateCalendarWithFlights(formattedFlights);
            updateFlightList(formattedFlights);
            hideLoading();
            // æ²å‹•åˆ°ä»Šæ—¥
            const todayCell = document.getElementById('today');
            if (todayCell) {
              todayCell.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
          }, 100);
          
        })
        .catch(error => {
          clearTimeout(timeoutId);
          console.error('Google Sheets CSV è¼‰å…¥å¤±æ•—:', error);
          hideLoading();

          const isNetworkError =
            error.message.includes('Failed to fetch') ||
            error.message.includes('Load failed') ||
            error.message.includes('NetworkError') ||
            error.message.includes('FetchEvent.respondWith');

          if (error.name === 'AbortError') {
            showConnectionError('é€£ç·šé€¾æ™‚ï¼ˆ20 ç§’ï¼‰ï¼Œè«‹æª¢æŸ¥ç¶²è·¯å¾Œé‡è©¦ã€‚');
          } else if (isNetworkError) {
            showConnectionError('ç¶²è·¯é€£ç·šå¤±æ•—ï¼Œç„¡æ³•å­˜å– Google Sheetsã€‚\nè«‹ç¢ºèªç¶²è·¯é€£ç·šå¾Œé‡è©¦ã€‚');
          } else {
            showConnectionError(`è¼‰å…¥éŒ¯èª¤: ${error.message}`);
          }
        });
    }
    
    // è§£æ CSV è³‡æ–™ç‚ºèˆªç­ç‰©ä»¶
    function parseCSVToFlights(csvText) {
      const lines = csvText.trim().split('\n');
      const flights = [];
      
      // è·³éç¬¬ä¸€è¡Œï¼ˆæ¨™é¡Œè¡Œï¼‰
      for (let i = 1; i < lines.length; i++) {
        const line = lines[i].trim();
        if (!line) continue;
        
        // è§£æ CSV è¡Œï¼ˆè™•ç†é€—è™Ÿåˆ†éš”å’Œå¼•è™ŸåŒ…åœçš„å€¼ï¼‰
        const values = parseCSVLine(line);
        
        // è·³éç©ºç™½è¡Œ
        if (!values[0]) continue;
        
        const flight = {
          date: formatDate(values[0]),
          airline: values[1] || '',
          departure: values[2] || '',
          arrival: values[3] || '',
          deptTime: values[4] || '',
          arrTime: values[5] || '',
          flightNo: values[6] || '',
          airlineEn: values[7] || '',
          // ç”¢ç”Ÿç°¡åŒ–ç‰ˆæœ¬çš„åœ°å
          departureShort: simplifyLocation(values[2]),
          arrivalShort: simplifyLocation(values[3])
        };
        
        flights.push(flight);
      }
      
      // æŒ‰æ—¥æœŸæ’åº
      flights.sort((a, b) => new Date(a.date) - new Date(b.date));
      
      return flights;
    }
    
    // è§£æ CSV è¡Œï¼ˆè™•ç†é€—è™Ÿå’Œå¼•è™Ÿï¼‰
    function parseCSVLine(line) {
      const values = [];
      let current = '';
      let inQuotes = false;
      
      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        
        if (char === '"') {
          inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
          values.push(current.trim());
          current = '';
        } else {
          current += char;
        }
      }
      
      // åŠ å…¥æœ€å¾Œä¸€å€‹å€¼
      values.push(current.trim());
      
      return values;
    }
    
    // æ ¼å¼åŒ–æ—¥æœŸç‚º YYYY-MM-DD
    function formatDate(date) {
      if (!date) return '';
      
      // å¦‚æœå·²ç¶“æ˜¯æ­£ç¢ºæ ¼å¼ï¼Œç›´æ¥è¿”å›
      if (/^\d{4}-\d{2}-\d{2}$/.test(date)) {
        return date;
      }
      
      const d = new Date(date);
      if (isNaN(d.getTime())) return date.toString();
      
      const year = d.getFullYear();
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      
      return `${year}-${month}-${day}`;
    }
    
    // ç°¡åŒ–åœ°åå‡½æ•¸ï¼ˆå¾ Apps Script è¤‡è£½ï¼‰
    function simplifyLocation(location) {
      if (!location) return '';
      
      const simplifications = {
        'å°åŒ—æ¡ƒåœ’': 'æ¡ƒåœ’',
        'å°åŒ—æ¾å±±': 'æ¾å±±',
        'ä¸Šæµ·æµ¦æ±': 'æµ¦æ±',
        'ä¸Šæµ·è™¹æ©‹': 'è™¹æ©‹',
        'é¦–çˆ¾ä»å·': 'ä»å·',
        'é¦–çˆ¾é‡‘æµ¦': 'é‡‘æµ¦'
      };
      
      return simplifications[location] || location;
    }
    
    // é¡¯ç¤ºé€£ç·šéŒ¯èª¤
    function showConnectionError(errorMessage = '') {
      const calendarWrap = document.querySelector('.calendar-wrap');

      calendarWrap.innerHTML = `
        <div style="text-align:center;padding:40px;color:#ef4444;">
          <div style="font-size:18px;margin-bottom:8px;">è¼‰å…¥å¤±æ•—</div>
          <div style="font-size:14px;color:#6b7280;margin-bottom:16px;">ç„¡æ³•å¾ Google Sheets è¼‰å…¥èˆªç­è³‡æ–™</div>
          ${errorMessage ? `<div style="font-size:13px;color:#ef4444;background:#fef2f2;border:1px solid #fecaca;border-radius:8px;padding:10px 14px;margin-top:8px;white-space:pre-wrap;text-align:left;">${errorMessage}</div>` : ''}
          <button onclick="loadFlightsFromGAS()" style="margin-top:16px;padding:8px 16px;background:#1d4ed8;color:white;border:none;border-radius:6px;cursor:pointer;">é‡æ–°è¼‰å…¥</button>
        </div>
      `;
    }
    
    // æ›´æ–°æ—¥æ›†é¡¯ç¤º
    function updateCalendarWithFlights(flights) {
      // æ¸…é™¤ç¾æœ‰çš„æ—¥æ›†
      const calendarWrap = document.querySelector('.calendar-wrap');
      calendarWrap.innerHTML = '';
      
      if (flights.length === 0) {
        calendarWrap.innerHTML = '<p style="text-align:center;padding:40px;color:#6b7280;">ç›®å‰æ²’æœ‰èˆªç­è³‡æ–™</p>';
        return;
      }
      
      // æŒ‰æœˆä»½åˆ†çµ„èˆªç­
      const flightsByMonth = {};
      flights.forEach(flight => {
        const monthKey = flight.date.substring(0, 7); // YYYY-MM
        if (!flightsByMonth[monthKey]) {
          flightsByMonth[monthKey] = [];
        }
        flightsByMonth[monthKey].push(flight);
      });
      
      // æŒ‰æ™‚é–“é †åºæ’åºæœˆä»½
      const sortedMonths = Object.keys(flightsByMonth).sort();
      
      // ç‚ºæ¯å€‹æœ‰èˆªç­çš„æœˆä»½ç”Ÿæˆæ—¥æ›†
      sortedMonths.forEach(monthKey => {
        const monthFlights = flightsByMonth[monthKey];
        const [year, month] = monthKey.split('-');
        const monthSection = generateMonthCalendar(parseInt(year), parseInt(month), monthFlights);
        calendarWrap.appendChild(monthSection);
      });
    }
    
    // ç”Ÿæˆå–®æœˆæ—¥æ›†
    function generateMonthCalendar(year, month, flights) {
      const monthNames = ['', 'ä¸€æœˆ', 'äºŒæœˆ', 'ä¸‰æœˆ', 'å››æœˆ', 'äº”æœˆ', 'å…­æœˆ', 'ä¸ƒæœˆ', 'å…«æœˆ', 'ä¹æœˆ', 'åæœˆ', 'åä¸€æœˆ', 'åäºŒæœˆ'];
      const daysInMonth = new Date(year, month, 0).getDate();
      const firstDay = new Date(year, month - 1, 1).getDay(); // 0=Sunday, 1=Monday, ...
      
      // å»ºç«‹èˆªç­ç´¢å¼•
      const flightsByDate = {};
      flights.forEach(flight => {
        const day = parseInt(flight.date.split('-')[2]);
        if (!flightsByDate[day]) {
          flightsByDate[day] = [];
        }
        flightsByDate[day].push(flight);
      });
      
      const section = document.createElement('section');
      section.className = 'month';
      section.id = `m-${year}-${String(month).padStart(2, '0')}`;
      
      // æœˆä»½æ¨™é¡Œ
      const header = document.createElement('header');
      header.className = 'month-header';
      header.innerHTML = `<h2>${year} å¹´ ${monthNames[month]}</h2>`;
      section.appendChild(header);
      
      // æ˜ŸæœŸæ¨™é¡Œ
      const weekHeader = document.createElement('div');
      weekHeader.className = 'grid header';
      weekHeader.innerHTML = '<div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div>';
      section.appendChild(weekHeader);
      
      // æ—¥æœŸæ ¼å­
      const bodyGrid = document.createElement('div');
      bodyGrid.className = 'grid body';
      
      // å‰é¢çš„ç©ºç™½æ ¼å­
      for (let i = 0; i < firstDay; i++) {
        const blankCell = document.createElement('div');
        blankCell.className = 'cell blank';
        bodyGrid.appendChild(blankCell);
      }
      
      // å–å¾—ä»Šå¤©çš„æ—¥æœŸ
      const today = new Date();
      const todayYear = today.getFullYear();
      const todayMonth = today.getMonth() + 1;
      const todayDay = today.getDate();
      
      // æ—¥æœŸæ ¼å­
      for (let day = 1; day <= daysInMonth; day++) {
        const cell = document.createElement('div');
        const hasFlights = flightsByDate[day] && flightsByDate[day].length > 0;
        const isToday = year === todayYear && month === todayMonth && day === todayDay;
        
        // è¨­å®š cell çš„ class
        let cellClass = 'cell';
        if (hasFlights) cellClass += ' has-event';
        if (isToday) cellClass += ' today';
        cell.className = cellClass;
        if (isToday) cell.id = 'today';
        
        const dateDiv = document.createElement('div');
        dateDiv.className = isToday ? 'date today' : 'date';
        dateDiv.textContent = day;
        cell.appendChild(dateDiv);
        
        // æ·»åŠ èˆªç­äº‹ä»¶
        if (hasFlights) {
          flightsByDate[day].forEach(flight => {
            const eventEl = document.createElement('div');
            eventEl.className = 'event';
            eventEl.id = `d-${flight.date}`;
            
            eventEl.innerHTML = `
              <div class="event-compact">
                <div class="time">${flight.deptTime}</div>
                <div class="route">${flight.departureShort} â†’ ${flight.arrivalShort}</div>
              </div>
              <div class="event-full">
                <div class="airline">${flight.airline} ${flight.airlineEn}</div>
                <div class="route">${flight.departure} â†’ ${flight.arrival}</div>
                <div class="meta">${flight.deptTime} â†’ ${flight.arrTime} ãƒ» ${flight.flightNo}</div>
              </div>
            `;
            
            cell.appendChild(eventEl);
          });
        }
        
        bodyGrid.appendChild(cell);
      }
      
      // å¾Œé¢çš„ç©ºç™½æ ¼å­ï¼ˆè®“æœ€å¾Œä¸€è¡Œå¡«æ»¿ï¼‰
      const totalCells = firstDay + daysInMonth;
      const remainingCells = 7 - (totalCells % 7);
      if (remainingCells < 7) {
        for (let i = 0; i < remainingCells; i++) {
          const blankCell = document.createElement('div');
          blankCell.className = 'cell blank';
          bodyGrid.appendChild(blankCell);
        }
      }
      
      section.appendChild(bodyGrid);
      return section;
    }
    
    // æ›´æ–°èˆªç­æ¸…å–®
    function updateFlightList(flights) {
      const listContainer = document.querySelector('#flightList');
      if (!listContainer) return;
      
      // æ¸…é™¤æ‰€æœ‰å…§å®¹
      listContainer.innerHTML = '';
      
      // é‡æ–°åŠ å…¥æ¨™é¡Œ
      const title = document.createElement('h2');
      title.textContent = 'èˆªç­æ¸…å–®';
      listContainer.appendChild(title);
      
      if (flights.length === 0) {
        const noDataMsg = document.createElement('div');
        noDataMsg.style.cssText = 'padding: 20px; color: #6b7280; font-size: 14px; text-align: center;';
        noDataMsg.textContent = 'ç›®å‰æ²’æœ‰èˆªç­è³‡æ–™';
        listContainer.appendChild(noDataMsg);
        return;
      }
      
      flights.forEach(flight => {
        const cardEl = document.createElement('a');
        cardEl.className = 'card';
        cardEl.href = `#d-${flight.date}`;
        cardEl.onclick = closeListOnMobile;
        
        cardEl.innerHTML = `
          <div class="date-tag">${flight.date}</div>
          <div class="airline">${flight.airline} ${flight.airlineEn}</div>
          <div class="route">${flight.departure} â†’ ${flight.arrival}</div>
          <div class="meta">${flight.deptTime} â†’ ${flight.arrTime} ãƒ» ${flight.flightNo}</div>
        `;
        
        listContainer.appendChild(cardEl);
      });
    }
    
    // â”€â”€ ä¸‹æ‹‰åˆ·æ–° (Pull-to-Refresh) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    (function() {
      const PTR_THRESHOLD = 70; // è§¸ç™¼æ‰€éœ€çš„ä¸‹æ‹‰è·é›¢ (px)
      const indicator = document.getElementById('ptrIndicator');
      let startY = 0;
      let pulling = false;
      let triggered = false;

      function setPtrY(dy) {
        // dy: 0 ~ PTR_THRESHOLDï¼Œæ˜ å°„åˆ°æŒ‡ç¤ºå™¨ä½ç½®
        const ratio = Math.min(dy / PTR_THRESHOLD, 1);
        const translateY = -60 + ratio * 70; // -60px â†’ 10px
        const rotate = ratio * 180;
        indicator.style.transform = `translateX(-50%) translateY(${translateY}px) rotate(${rotate}deg)`;
        indicator.style.opacity = ratio;
        indicator.classList.toggle('visible', ratio > 0.1);
      }

      document.addEventListener('touchstart', (e) => {
        // åªåœ¨é é¢é ‚ç«¯ä¸”æ²’æœ‰æ­£åœ¨è¼‰å…¥æ™‚å•Ÿå‹•
        if (window.scrollY === 0 && !document.getElementById('loadingModal').classList.contains('show')) {
          startY = e.touches[0].clientY;
          pulling = true;
          triggered = false;
          indicator.classList.remove('spinning');
        }
      }, { passive: true });

      document.addEventListener('touchmove', (e) => {
        if (!pulling) return;
        const dy = e.touches[0].clientY - startY;
        if (dy > 0) {
          setPtrY(dy);
          if (dy >= PTR_THRESHOLD && !triggered) {
            triggered = true;
            // éœ‡å‹•å›é¥‹ï¼ˆè‹¥è£ç½®æ”¯æ´ï¼‰
            if (navigator.vibrate) navigator.vibrate(30);
          }
        }
      }, { passive: true });

      document.addEventListener('touchend', () => {
        if (!pulling) return;
        pulling = false;
        if (triggered) {
          // é–å®šåœ¨è§¸ç™¼ä½ç½®ä¸¦æ—‹è½‰ï¼Œç­‰è¼‰å…¥å®Œæˆå†æ”¶å›
          indicator.style.transform = 'translateX(-50%) translateY(10px) rotate(0deg)';
          indicator.classList.add('spinning');
          loadFlightsFromGAS();
        } else {
          // æ”¶å›æŒ‡ç¤ºå™¨
          indicator.style.transition = 'transform 0.3s ease, opacity 0.3s ease';
          setPtrY(0);
          setTimeout(() => { indicator.style.transition = ''; }, 300);
        }
      }, { passive: true });

      window._ptrHide = function() {
        indicator.classList.remove('spinning');
        indicator.style.transition = 'transform 0.3s ease, opacity 0.3s ease';
        setPtrY(0);
        setTimeout(() => { indicator.style.transition = ''; }, 300);
      };
    })();
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    document.addEventListener('DOMContentLoaded', () => {
      loadFlightsFromGAS();
    });

    // Register Service Worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js').catch(err => {
        console.warn('Service Worker registration failed:', err);
      });
    }
    
  </script>
</body>
</html>
