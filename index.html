<!doctype html>
<html lang="zh-Hant">

<head>
  <meta charset="utf-8" />
  <meta name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>飛行行事曆</title>
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#1d4ed8" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="My Flights" />
  <link rel="apple-touch-icon" href="icon.svg" />
  <style>
    :root {
      --bg: #ffffff;
      --text: #111827;
      --muted: #6b7280;
      --line: #e5e7eb;
      --event: #eef2ff;
      --brand: #1d4ed8;
      --card: #f9fafb;
      --header-h: 44px;
      --nav-h: 56px;
    }

    html,
    body {
      background: var(--bg);
      color: var(--text);
      margin: 0
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang TC", "Noto Sans TC", Roboto, "Helvetica Neue", Arial, "Microsoft JhengHei", sans-serif
    }

    /* ── Header ─────────────────────────────────────────────── */
    header {
      position: sticky;
      top: 0;
      z-index: 30;
      background: #fff;
      border-bottom: 1px solid var(--line);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 14px;
      height: var(--header-h);
      box-sizing: border-box
    }

    header h1 {
      margin: 0;
      font-size: 18px
    }

    .refresh-btn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0.7;
      transition: opacity 0.2s
    }

    .refresh-btn:hover {
      opacity: 1
    }

    .refresh-btn:disabled {
      opacity: 0.3;
      cursor: default
    }

    .refresh-btn.spinning svg {
      animation: refresh-spin 0.8s linear infinite
    }

    .refresh-btn:disabled {
      opacity: 0.7;
      cursor: default
    }

    @keyframes refresh-spin {
      from {
        transform: rotate(0deg)
      }

      to {
        transform: rotate(360deg)
      }
    }

    .list-spinner {
      width: 36px;
      height: 36px;
      border: 4px solid #e5e7eb;
      border-top-color: #1d4ed8;
      border-radius: 50%;
      animation: refresh-spin 0.7s linear infinite;
      margin: 0 auto
    }

    /* ── Panels ─────────────────────────────────────────────── */
    .panel {
      display: none;
      padding-bottom: calc(var(--nav-h) + env(safe-area-inset-bottom, 0px))
    }

    .panel.active {
      display: block
    }

    /* ── Calendar ───────────────────────────────────────────── */
    .calendar-wrap {
      padding: 0
    }

    .month {
      border-top: 1px solid var(--line)
    }

    .month:first-of-type {
      border-top: none
    }

    .month-header {
      position: sticky;
      top: var(--header-h);
      background: rgba(255, 255, 255, .95);
      backdrop-filter: saturate(180%) blur(8px);
      border-bottom: 1px solid var(--line);
      padding: 8px 10px;
      z-index: 10
    }

    .month-header h2 {
      margin: 0;
      font-size: 16px
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(7, minmax(0, 1fr))
    }

    .grid.header>div {
      padding: 6px;
      text-align: center;
      font-size: 11px;
      color: #6b7280;
      border-bottom: 1px solid var(--line);
      border-right: 1px solid var(--line);
      background: #fafafa
    }

    .grid.header>div:nth-child(7n) {
      border-right: none
    }

    .cell {
      min-height: 80px;
      border-right: 1px solid var(--line);
      border-bottom: 1px solid var(--line);
      padding: 5px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      background: #fff
    }

    .cell:nth-child(7n) {
      border-right: none
    }

    .cell.blank {
      background: #fff
    }

    .date {
      font-size: 12px;
      color: #9ca3af
    }

    .date.today {
      background: #1d4ed8;
      color: #fff;
      border-radius: 50%;
      width: 22px;
      height: 22px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 11px
    }

    .cell.today {
      background: linear-gradient(135deg, #f0f7ff 0%, #e0f0ff 100%)
    }

    .event {
      background: var(--event);
      border: 1px solid #c7d2fe;
      border-radius: 7px;
      padding: 4px 5px;
      line-height: 1.3;
      word-wrap: break-word;
      overflow-wrap: break-word;
      min-width: 0;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent
    }

    .event:active {
      background: #c7d2fe
    }

    .event .etime {
      font-weight: 700;
      font-size: 11px;
      color: #4338ca
    }

    .event .eroute {
      font-size: 11px;
      color: #374151;
      margin-top: 1px
    }

    .event-full {
      display: none
    }

    .has-event {
      background: linear-gradient(180deg, #ffffff 0%, #ffffff 65%, #f3f6ff 100%)
    }

    .cell.today.has-event {
      background: linear-gradient(135deg, #f0f7ff 0%, #e0f0ff 100%)
    }

    /* ── List panels ────────────────────────────────────────── */
    .list-wrap {
      padding: 12px
    }

    .lcard {
      border: 1px solid var(--line);
      border-radius: 12px;
      background: var(--card);
      padding: 12px 14px;
      margin-bottom: 10px;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
      transition: background 0.15s
    }

    .lcard:active {
      background: #eef2ff;
      border-color: #c7d2fe
    }

    .lcard.departed {
      opacity: 0.5
    }

    .lcard .date-tag {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 3px
    }

    .lcard .airline {
      font-weight: 600;
      color: #1d4ed8;
      font-size: 14px
    }

    .lcard .route {
      font-size: 13px;
      margin-top: 3px
    }

    .lcard .meta {
      font-size: 12px;
      color: #374151;
      margin-top: 3px
    }

    .list-empty {
      padding: 48px 20px;
      text-align: center;
      color: #6b7280;
      font-size: 14px
    }

    /* ── Bottom nav ─────────────────────────────────────────── */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: calc(var(--nav-h) + env(safe-area-inset-bottom, 0px));
      background: #fff;
      border-top: 1px solid var(--line);
      display: flex;
      z-index: 30
    }

    .bn-item {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 10px;
      color: #6b7280;
      gap: 3px;
      position: relative;
      padding: 0 0 env(safe-area-inset-bottom, 0px);
      -webkit-tap-highlight-color: transparent
    }

    .bn-item.active {
      color: var(--brand)
    }

    .bn-item svg {
      width: 22px;
      height: 22px;
      stroke: currentColor;
      fill: none;
      stroke-width: 2;
      stroke-linecap: round;
      stroke-linejoin: round
    }

    .bn-badge {
      position: absolute;
      top: 5px;
      right: calc(50% - 22px);
      min-width: 16px;
      height: 16px;
      padding: 0 4px;
      border-radius: 999px;
      background: #ef4444;
      color: #fff;
      font-size: 10px;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      box-sizing: border-box
    }

    .bn-badge[data-count="0"] {
      display: none
    }

    /* ── Modal ──────────────────────────────────────────────── */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 50;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
      box-sizing: border-box
    }

    .modal-overlay.show {
      display: flex
    }

    .modal-content {
      background: #fff;
      border-radius: 16px;
      padding: 20px;
      width: 100%;
      max-width: 320px;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      transform: scale(0.9);
      transition: transform 0.2s ease
    }

    .modal-overlay.show .modal-content {
      transform: scale(1)
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--line)
    }

    .modal-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text)
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      color: #9ca3af;
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center
    }

    .modal-close:hover {
      color: var(--text)
    }

    .modal-body .m-airline {
      font-weight: 600;
      color: #1d4ed8;
      font-size: 15px;
      margin-bottom: 8px
    }

    .modal-body .m-route {
      font-size: 14px;
      margin-bottom: 6px;
      color: var(--text)
    }

    .modal-body .m-meta {
      font-size: 13px;
      color: #6b7280;
      margin-bottom: 4px
    }

    /* ── Loading ────────────────────────────────────────────── */
    .inline-loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: calc(100vh - 120px);
      padding: 40px
    }

    .loading-text {
      font-size: 13px;
      color: #6b7280;
      font-weight: 500;
      margin-top: 14px
    }

    /* ── Stale badge (background refresh indicator) ─────────── */
    .stale-badge {
      position: fixed;
      bottom: calc(var(--nav-h) + env(safe-area-inset-bottom, 0px) + 10px);
      left: 50%;
      transform: translateX(-50%);
      background: rgba(29, 78, 216, 0.92);
      color: #fff;
      font-size: 12px;
      padding: 6px 14px;
      border-radius: 20px;
      z-index: 40;
      white-space: nowrap;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none
    }

    .stale-badge.show {
      opacity: 1
    }
  </style>
</head>

<body>


  <header>
    <h1>My Flights</h1>
    <button id="refreshBtn" class="refresh-btn" aria-label="重新整理">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
        stroke-linecap="round" stroke-linejoin="round">
        <path d="M3 12a9 9 0 0 1 15-6.7L21 8" />
        <path d="M21 3v5h-5" />
        <path d="M21 12a9 9 0 0 1-15 6.7L3 16" />
        <path d="M3 21v-5h5" />
      </svg>
    </button>
  </header>

  <!-- Calendar panel -->
  <div id="panelCalendar" class="panel active">
    <div class="calendar-wrap"></div>
  </div>

  <!-- Upcoming panel -->
  <div id="panelUpcoming" class="panel">
    <div class="list-wrap" id="listUpcoming"></div>
  </div>

  <!-- Departed panel -->
  <div id="panelDeparted" class="panel">
    <div class="list-wrap" id="listDeparted"></div>
  </div>

  <!-- Bottom nav -->
  <nav class="bottom-nav">
    <button class="bn-item active" data-panel="panelCalendar">
      <svg viewBox="0 0 24 24">
        <rect x="3" y="4" width="18" height="18" rx="2" />
        <line x1="16" y1="2" x2="16" y2="6" />
        <line x1="8" y1="2" x2="8" y2="6" />
        <line x1="3" y1="10" x2="21" y2="10" />
      </svg>
      行事曆
    </button>
    <button class="bn-item" data-panel="panelUpcoming">
      <span class="bn-badge" id="badgeUpcoming" data-count="0">0</span>
      <svg viewBox="0 0 24 24">
        <line x1="22" y1="2" x2="11" y2="13" />
        <polygon points="22 2 15 22 11 13 2 9 22 2" />
      </svg>
      待出發
    </button>
    <button class="bn-item" data-panel="panelDeparted">
      <svg viewBox="0 0 24 24">
        <polyline points="20 6 9 17 4 12" />
      </svg>
      已出發
    </button>
  </nav>

  <!-- Modal -->
  <div id="flightModal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">航班詳情</div>
        <button class="modal-close" id="closeModal">×</button>
      </div>
      <div class="modal-body" id="modalBody"></div>
    </div>
  </div>

  <script>
    const SHEETS_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQqkpj4xzdNRa2qC30VjkGq-eLJcbrv-hPRKa6si93WEFsekexY4EYXnPiZJVWldHRHrG4lR-cyKBbP/pub?gid=665636533&single=true&output=csv';

    let isLoading = false;
    let currentPanel = 'panelCalendar';

    // ── Bottom nav ────────────────────────────────────────────────
    function switchPanel(panelId) {
      if (panelId === currentPanel) return;
      document.getElementById(currentPanel).classList.remove('active');
      document.getElementById(panelId).classList.add('active');
      document.querySelectorAll('.bn-item').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.panel === panelId);
      });
      currentPanel = panelId;
      window.scrollTo(0, 0);
    }

    document.querySelectorAll('.bn-item').forEach(btn => {
      btn.addEventListener('click', () => switchPanel(btn.dataset.panel));
    });

    // ── Refresh button ────────────────────────────────────────────
    document.getElementById('refreshBtn').addEventListener('click', loadFlightsFromGAS);

    // ── Modal ─────────────────────────────────────────────────────
    const modal = document.getElementById('flightModal');
    const modalBody = document.getElementById('modalBody');

    function showFlightModal(flight) {
      modalBody.innerHTML = `
        <div class="m-airline">${flight.airline} ${flight.airlineEn}</div>
        <div class="m-route">${flight.departure} → ${flight.arrival}</div>
        <div class="m-meta">${flight.date}</div>
        <div class="m-meta">${flight.deptTime} → ${flight.arrTime}</div>
        <div class="m-meta">航班：${flight.flightNo}</div>
      `;
      modal.classList.add('show');
      document.body.style.overflow = 'hidden';
    }

    function hideModal() {
      modal.classList.remove('show');
      document.body.style.overflow = '';
    }

    document.getElementById('closeModal').addEventListener('click', hideModal);
    modal.addEventListener('click', e => { if (e.target === modal) hideModal(); });
    document.addEventListener('keydown', e => { if (e.key === 'Escape') hideModal(); });

    // ── LocalStorage Cache ────────────────────────────────────────
    const CACHE_KEY = 'flights_cache_v1';
    const CACHE_TS_KEY = 'flights_cache_ts_v1';

    function saveToCache(flights) {
      try {
        localStorage.setItem(CACHE_KEY, JSON.stringify(flights));
        localStorage.setItem(CACHE_TS_KEY, Date.now().toString());
      } catch (e) { console.warn('快取寫入失敗:', e); }
    }

    function loadFromCache() {
      try {
        const raw = localStorage.getItem(CACHE_KEY);
        return raw ? JSON.parse(raw) : null;
      } catch (e) { return null; }
    }

    function getCacheAge() {
      const ts = localStorage.getItem(CACHE_TS_KEY);
      return ts ? Math.floor((Date.now() - parseInt(ts)) / 60000) : null; // 分鐘
    }

    // ── Loading ───────────────────────────────────────────────────
    function startRefreshSpin() {
      const btn = document.getElementById('refreshBtn');
      if (btn) { btn.disabled = true; btn.classList.add('spinning'); }
    }

    function stopRefreshSpin() {
      const btn = document.getElementById('refreshBtn');
      if (btn) { btn.disabled = false; btn.classList.remove('spinning'); }

    }

    function showLoading() {
      isLoading = true;
      const calendarWrap = document.querySelector('#panelCalendar .calendar-wrap');
      calendarWrap.innerHTML = `
        <div class="inline-loading">
          <div class="list-spinner"></div>
          <div class="loading-text">正在載入航班資料...</div>
        </div>`;
      ['listUpcoming', 'listDeparted'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.innerHTML = '<div class="inline-loading"><div class="list-spinner"></div></div>';
      });
      startRefreshSpin();
    }

    function hideLoading() {
      isLoading = false;
      stopRefreshSpin();
    }

    // ── Stale badge ───────────────────────────────────────────────
    function showStaleBadge(msg) {
      let badge = document.getElementById('staleBadge');
      if (!badge) {
        badge = document.createElement('div');
        badge.id = 'staleBadge';
        badge.className = 'stale-badge';
        document.body.appendChild(badge);
      }
      badge.textContent = msg;
      badge.classList.add('show');
      setTimeout(() => badge.classList.remove('show'), 3000);
    }

    // ── Data loading ──────────────────────────────────────────────
    function applyFlights(flights, { scrollToToday = true } = {}) {
      updateCalendarWithFlights(flights);
      updateFlightList(flights);
      if (scrollToToday) {
        const todayCell = document.getElementById('today');
        if (todayCell) todayCell.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }

    function fetchAndProcess(signal) {
      return fetch(SHEETS_CSV_URL, { signal })
        .then(response => {
          if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          return response.text();
        })
        .then(csvText => {
          const flights = parseCSVToFlights(csvText);
          if (flights.length === 0) throw new Error('解析後沒有找到任何航班資料');
          return flights.map(f => ({
            ...f,
            deptTime: formatTimeOnFrontend(f.deptTime),
            arrTime: formatTimeOnFrontend(f.arrTime)
          }));
        });
    }

    function loadFlightsFromGAS({ silent = false } = {}) {
      // ── Step 1: Show cached data immediately ──────────────────
      const cached = loadFromCache();
      if (cached && !silent) {
        applyFlights(cached);
        // Show faint spinner in header only (not full-screen loading)
        startRefreshSpin();
        isLoading = true;
      } else if (!silent) {
        showLoading();
      }

      // ── Step 2: Fetch fresh data in background ────────────────
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 20000);

      fetchAndProcess(controller.signal)
        .then(flights => {
          clearTimeout(timeoutId);
          saveToCache(flights);

          if (silent) {
            // Silent background update: just refresh the UI quietly
            applyFlights(flights, { scrollToToday: false });
            showStaleBadge('✓ 航班資料已更新');
          } else if (cached) {
            // Had cache: update UI quietly without scroll jump
            applyFlights(flights, { scrollToToday: false });
            hideLoading();
            const age = getCacheAge();
            if (age !== null && age > 0) showStaleBadge(`✓ 已更新（上次快取：${age} 分鐘前）`);
          } else {
            // First load ever: apply with scroll
            applyFlights(flights);
            hideLoading();
          }
        })
        .catch(error => {
          clearTimeout(timeoutId);
          console.error('載入失敗:', error);

          if (silent) return; // Silent mode: don't show error if we have cache

          hideLoading();

          if (cached) {
            // Still have old cache, show badge only
            showStaleBadge('⚠ 無法更新，顯示快取資料');
            return;
          }

          const isNetworkError =
            error.message.includes('Failed to fetch') ||
            error.message.includes('Load failed') ||
            error.message.includes('NetworkError') ||
            error.message.includes('FetchEvent.respondWith');

          if (error.name === 'AbortError') {
            showConnectionError('連線逾時（20 秒），請檢查網路後重試。');
          } else if (isNetworkError) {
            showConnectionError('網路連線失敗，請確認網路連線後重試。');
          } else {
            showConnectionError(`載入錯誤: ${error.message}`);
          }
        });
    }

    // ── CSV parsing ───────────────────────────────────────────────
    function parseCSVToFlights(csvText) {
      const lines = csvText.trim().split('\n');
      const flights = [];
      for (let i = 1; i < lines.length; i++) {
        const line = lines[i].trim();
        if (!line) continue;
        const values = parseCSVLine(line);
        if (!values[0]) continue;
        flights.push({
          date: formatDate(values[0]),
          airline: values[1] || '',
          departure: values[2] || '',
          arrival: values[3] || '',
          deptTime: values[4] || '',
          arrTime: values[5] || '',
          flightNo: values[6] || '',
          airlineEn: values[7] || '',
          departureShort: simplifyLocation(values[2]),
          arrivalShort: simplifyLocation(values[3])
        });
      }
      flights.sort((a, b) => new Date(a.date) - new Date(b.date));
      return flights;
    }

    function parseCSVLine(line) {
      const values = [];
      let current = '';
      let inQuotes = false;
      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        if (char === '"') { inQuotes = !inQuotes; }
        else if (char === ',' && !inQuotes) { values.push(current.trim()); current = ''; }
        else { current += char; }
      }
      values.push(current.trim());
      return values;
    }

    function formatDate(date) {
      if (!date) return '';
      if (/^\d{4}-\d{2}-\d{2}$/.test(date)) return date;
      const d = new Date(date);
      if (isNaN(d.getTime())) return date.toString();
      return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
    }

    function simplifyLocation(location) {
      if (!location) return '';
      const m = { '台北桃園': '桃園', '台北松山': '松山', '上海浦東': '浦東', '上海虹橋': '虹橋', '首爾仁川': '仁川', '首爾金浦': '金浦' };
      return m[location] || location;
    }

    function formatTimeOnFrontend(timeStr) {
      if (!timeStr) return '';
      if (/^\d{1,2}:\d{2}$/.test(timeStr)) return timeStr;
      if (typeof timeStr === 'string' && timeStr.includes('T')) {
        try {
          const date = new Date(timeStr);
          if (!isNaN(date.getTime())) {
            if (date.getFullYear() === 1899) {
              let h = date.getUTCHours() + 8;
              if (h >= 24) h -= 24;
              return `${String(h).padStart(2, '0')}:${String(date.getUTCMinutes()).padStart(2, '0')}`;
            } else {
              return `${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
            }
          }
        } catch (e) { }
      }
      return timeStr;
    }

    // ── Calendar ──────────────────────────────────────────────────
    function updateCalendarWithFlights(flights) {
      const calendarWrap = document.querySelector('#panelCalendar .calendar-wrap');
      calendarWrap.innerHTML = '';
      if (flights.length === 0) {
        calendarWrap.innerHTML = '<p style="text-align:center;padding:40px;color:#6b7280;">目前沒有航班資料</p>';
        return;
      }
      const flightsByMonth = {};
      flights.forEach(f => {
        const k = f.date.substring(0, 7);
        if (!flightsByMonth[k]) flightsByMonth[k] = [];
        flightsByMonth[k].push(f);
      });
      Object.keys(flightsByMonth).sort().forEach(monthKey => {
        const [year, month] = monthKey.split('-');
        calendarWrap.appendChild(generateMonthCalendar(parseInt(year), parseInt(month), flightsByMonth[monthKey]));
      });
    }

    function generateMonthCalendar(year, month, flights) {
      const monthNames = ['', '一月', '二月', '三月', '四月', '五月', '六月', '七月', '八月', '九月', '十月', '十一月', '十二月'];
      const daysInMonth = new Date(year, month, 0).getDate();
      const firstDay = new Date(year, month - 1, 1).getDay();

      const flightsByDate = {};
      flights.forEach(f => {
        const day = parseInt(f.date.split('-')[2]);
        if (!flightsByDate[day]) flightsByDate[day] = [];
        flightsByDate[day].push(f);
      });

      const section = document.createElement('section');
      section.className = 'month';
      section.id = `m-${year}-${String(month).padStart(2, '0')}`;

      const hdr = document.createElement('header');
      hdr.className = 'month-header';
      hdr.innerHTML = `<h2>${year} 年 ${monthNames[month]}</h2>`;
      section.appendChild(hdr);

      const weekHdr = document.createElement('div');
      weekHdr.className = 'grid header';
      weekHdr.innerHTML = '<div>日</div><div>一</div><div>二</div><div>三</div><div>四</div><div>五</div><div>六</div>';
      section.appendChild(weekHdr);

      const bodyGrid = document.createElement('div');
      bodyGrid.className = 'grid body';

      for (let i = 0; i < firstDay; i++) {
        const blank = document.createElement('div');
        blank.className = 'cell blank';
        bodyGrid.appendChild(blank);
      }

      const today = new Date();
      const ty = today.getFullYear(), tm = today.getMonth() + 1, td = today.getDate();

      for (let day = 1; day <= daysInMonth; day++) {
        const cell = document.createElement('div');
        const dayFlights = flightsByDate[day];
        const hasFlights = !!(dayFlights && dayFlights.length > 0);
        const isToday = year === ty && month === tm && day === td;

        cell.className = 'cell' + (hasFlights ? ' has-event' : '') + (isToday ? ' today' : '');
        if (isToday) cell.id = 'today';

        const dateDiv = document.createElement('div');
        dateDiv.className = isToday ? 'date today' : 'date';
        dateDiv.textContent = day;
        cell.appendChild(dateDiv);

        if (hasFlights) {
          dayFlights.forEach(flight => {
            const eventEl = document.createElement('div');
            eventEl.className = 'event';
            eventEl.id = `d-${flight.date}`;
            eventEl.innerHTML = `
              <div class="etime">${flight.deptTime}</div>
              <div class="eroute">${flight.departureShort}→${flight.arrivalShort}</div>
            `;
            eventEl.addEventListener('click', e => {
              e.stopPropagation();
              showFlightModal(flight);
            });
            cell.appendChild(eventEl);
          });
        }

        bodyGrid.appendChild(cell);
      }

      const totalCells = firstDay + daysInMonth;
      const remaining = 7 - (totalCells % 7);
      if (remaining < 7) {
        for (let i = 0; i < remaining; i++) {
          const blank = document.createElement('div');
          blank.className = 'cell blank';
          bodyGrid.appendChild(blank);
        }
      }

      section.appendChild(bodyGrid);
      return section;
    }

    // ── Flight list ───────────────────────────────────────────────
    function updateFlightList(flights) {
      const todayStr = new Date().toISOString().slice(0, 10);
      const upcoming = flights.filter(f => f.date >= todayStr);
      const departed = flights.filter(f => f.date < todayStr).reverse();

      const badgeUp = document.getElementById('badgeUpcoming');
      badgeUp.textContent = upcoming.length;
      badgeUp.dataset.count = upcoming.length;

      buildCards(upcoming, document.getElementById('listUpcoming'), false);
      buildCards(departed, document.getElementById('listDeparted'), true);
    }

    function buildCards(list, container, isDeparted) {
      container.innerHTML = '';
      if (list.length === 0) {
        container.innerHTML = '<div class="list-empty">沒有航班</div>';
        return;
      }
      list.forEach(flight => {
        const card = document.createElement('div');
        card.className = 'lcard' + (isDeparted ? ' departed' : '');
        card.innerHTML = `
          <div class="date-tag">${flight.date}</div>
          <div class="airline">${flight.airline} ${flight.airlineEn}</div>
          <div class="route">${flight.departure} → ${flight.arrival}</div>
          <div class="meta">${flight.deptTime} → ${flight.arrTime} ・ ${flight.flightNo}</div>
        `;
        card.addEventListener('click', () => {
          switchPanel('panelCalendar');
          setTimeout(() => {
            const target = document.getElementById('d-' + flight.date);
            if (target) target.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }, 50);
        });
        container.appendChild(card);
      });
    }

    function showConnectionError(msg) {
      const calendarWrap = document.querySelector('#panelCalendar .calendar-wrap');
      calendarWrap.innerHTML = `
        <div style="text-align:center;padding:40px;color:#ef4444;">
          <div style="font-size:18px;margin-bottom:8px;">載入失敗</div>
          <div style="font-size:14px;color:#6b7280;margin-bottom:16px;">無法從 Google Sheets 載入航班資料</div>
          ${msg ? `<div style="font-size:13px;color:#ef4444;background:#fef2f2;border:1px solid #fecaca;border-radius:8px;padding:10px 14px;margin-top:8px;white-space:pre-wrap;text-align:left;">${msg}</div>` : ''}
          <button onclick="loadFlightsFromGAS()" style="margin-top:16px;padding:8px 16px;background:#1d4ed8;color:white;border:none;border-radius:6px;cursor:pointer;">重新載入</button>
        </div>`;
    }



    // ── Init ──────────────────────────────────────────────────────
    document.addEventListener('DOMContentLoaded', loadFlightsFromGAS);

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js').catch(err => {
        console.warn('Service Worker registration failed:', err);
      });
    }
  </script>
</body>

</html>